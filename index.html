<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø¹Ù„Ù… - Ø¨Ø« SFU</title>
    <style>
        body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; }
        video { width: 60%; background: black; border-radius: 10px; margin-top: 20px; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background: #4361ee; color: white; border: none; border-radius: 5px; }
    </style>
    <!-- Ù…ÙƒØªØ¨Ø© Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© Mediasoup Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mediasoup-client/3.6.85/mediasoup-client.min.js"></script>
</head>
<body>
    <h1>ðŸŽ¥ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</h1>
    <button id="btnLocalVideo">1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button id="btnStart" disabled>2. Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« (Live)</button>
    <br>
    <video id="localVideo" autoplay playsinline muted></video>
    <div id="status"></div>

    <script>
        const ioClient = io;
        const mediasoupClient = mediasoupClient;
        
        const socket = io("http://localhost:3000"); // âš ï¸ ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ù„Ø±Ø§Ø¨Ø· Ø³ÙŠØ±ÙØ±Ùƒ
        
        let device;
        let producerTransport;
        let videoProducer;
        let audioProducer;
        let localStream;

        const btnLocalVideo = document.getElementById('btnLocalVideo');
        const btnStart = document.getElementById('btnStart');
        const status = document.getElementById('status');

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        btnLocalVideo.addEventListener('click', async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                btnStart.disabled = false;
                btnLocalVideo.disabled = true;
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        });

        // 2. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        btnStart.addEventListener('click', () => {
            btnStart.disabled = true;
            joinRoom();
        });

        socket.on('connection-success', ({ socketId }) => {
            console.log("Connected to server:", socketId);
        });

        async function joinRoom() {
            // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø±Ø§ÙˆØªØ±
            socket.emit('getRouterRtpCapabilities', async (rtpCapabilities) => {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² (Device)
                device = new mediasoupClient.Device();
                await device.load({ routerRtpCapabilities: rtpCapabilities });

                // 2. Ø¥Ù†Ø´Ø§Ø¡ Transport Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                createSendTransport();
            });
        }

        function createSendTransport() {
            socket.emit('createWebRtcTransport', { sender: true }, ({ params }) => {
                if (params.error) {
                    console.log(params.error);
                    return;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Transport Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
                producerTransport = device.createSendTransport(params);

                // Ø­Ø¯Ø« Ø§Ù„Ø§ØªØµØ§Ù„
                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    try {
                        socket.emit('transport-connect', { dtlsParameters });
                        callback();
                    } catch (error) {
                        errback(error);
                    }
                });

                // Ø­Ø¯Ø« Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Produce)
                producerTransport.on('produce', async (parameters, callback, errback) => {
                    try {
                        socket.emit('transport-produce', {
                            kind: parameters.kind,
                            rtpParameters: parameters.rtpParameters,
                            appData: parameters.appData,
                        }, ({ id }) => {
                            callback({ id });
                        });
                    } catch (error) {
                        errback(error);
                    }
                });

                connectSendTransport();
            });
        }

        async function connectSendTransport() {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const videoTrack = localStream.getVideoTracks()[0];
            const audioTrack = localStream.getAudioTracks()[0];

            videoProducer = await producerTransport.produce({ track: videoTrack });
            audioProducer = await producerTransport.produce({ track: audioTrack });

            status.innerHTML = "âœ… Ø§Ù„Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†!";
            
            videoProducer.on('trackended', () => {
                console.log('video track ended');
            });

            videoProducer.on('transportclose', () => {
                console.log('video transport closed');
            });
        }
    </script>
</body>
</html>
