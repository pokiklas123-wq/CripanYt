<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù‘Ù†</title>
    <style>
        body { margin:0; padding:20px; background:#111; text-align:center; font-family:Arial; color:#fff; }
        #localVideo { width:100%; max-width:640px; background:#222; border-radius:10px; margin:10px auto; }
        button { padding:15px 25px; margin:10px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
        #status { margin:15px; padding:12px; background:#333; border-radius:6px; min-height:24px; }
        #log { text-align:left; margin:20px auto; padding:15px; background:#1a1a1a; border-radius:8px; max-width:800px; font-family:monospace; font-size:12px; white-space:pre-wrap; max-height:200px; overflow-y:auto; }
    </style>
    <script src="https://ant-media-2kbz.onrender.com/live/js/webrtc_adaptor.js"></script>
</head>
<body>
    <h3>ğŸ¥ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± WebView - (Ù†Ø³Ø®Ø© ØªØ´Ø®ÙŠØµ)</h3>
    <video id="localVideo" autoplay playsinline muted></video>
    <br>
    <button onclick="listDevices()" style="background:#FF9800;">ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</button>
    <button onclick="startBroadcast()" style="background:#4CAF50;">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
    <button onclick="stopBroadcast()" style="background:#f44336;">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
    <p id="status">âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„</p>
    <div id="log">Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:<br></div>

    <script>
        const SERVER_URL = "https://ant-media-2kbz.onrender.com/live/websocket";
        const STREAM_ID = "test_stream_" + Math.floor(Math.random() * 1000);
        
        let webRTCAdaptor = null;
        let localStream = null;
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const localVideo = document.getElementById('localVideo');

        // ========== ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ==========
        function addLog(message) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // ========== ÙØ­Øµ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­Ø© ==========
        async function listDevices() {
            addLog("--- ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ---");
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                devices.forEach(device => {
                    addLog(`ğŸ“Ÿ ${device.kind}: ${device.label || 'Ø§Ø³Ù… ØºÙŠØ± Ù…ØªØ§Ø­'} (ID: ${device.deviceId})`);
                });
                statusEl.textContent = "ØªÙ… ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŒ Ø§Ù†Ø¸Ø± Ø§Ù„Ø³Ø¬Ù„";
            } catch (err) {
                addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©: ${err.message}`);
            }
        }

        // ========== Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« (Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù†) ==========
        async function startBroadcast() {
            statusEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØµÙˆØª...";
            addLog("--- Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« ---");
            
            try {
                // 1. Ø·Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙØµÙ„Ø© Ù„Ù„ØµÙˆØª (Ù„Ù„ØªØºÙ„Ø¨ Ø¹Ù„Ù‰ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„)
                const mediaConstraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    },
                    audio: {
                        echoCancellation: false,   // Ø¥ÙŠÙ‚Ø§Ù Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ù‰ (Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„)
                        noiseSuppression: false,   // Ø¥ÙŠÙ‚Ø§Ù ÙƒØªÙ… Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
                        autoGainControl: false,    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª
                        channelCount: 1,           // Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø£Ø­Ø§Ø¯ÙŠ (Ø£Ø¨Ø³Ø·)
                        sampleRate: 44100,         // ØªØ±Ø¯Ø¯ Ø£Ø®Ø° Ø¹ÙŠÙ†Ø§Øª Ù‚ÙŠØ§Ø³ÙŠ
                        sampleSize: 16             // Ø­Ø¬Ù… Ø§Ù„Ø¹ÙŠÙ†Ø© Ù‚ÙŠØ§Ø³ÙŠ
                    }
                };
                
                addLog("Ø·Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: " + JSON.stringify(mediaConstraints));
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                
                // 2. Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
                localVideo.srcObject = localStream;
                const videoTrack = localStream.getVideoTracks()[0];
                const audioTrack = localStream.getAudioTracks()[0];
                addLog(`âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø¨Ù†Ø¬Ø§Ø­`);
                addLog(`   ÙƒØ§Ù…ÙŠØ±Ø§: ${videoTrack.label || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
                addLog(`   Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${audioTrack.label || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
                addLog(`   Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ${audioTrack.enabled ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„'}`);
                addLog(`   Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª: ${audioTrack.muted ? 'Ù…ÙƒØªÙˆÙ…' : 'ØºÙŠØ± Ù…ÙƒØªÙˆÙ…'}`);
                
                statusEl.textContent = "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...";
                
                // 3. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ant Media
                webRTCAdaptor = new WebRTCAdaptor({
                    websocket_url: SERVER_URL,
                    mediaConstraints: { video: true, audio: true },
                    peerconnection_config: { 
                        iceServers: [
                            { urls: "stun:stun.l.google.com:19302" },
                            { urls: "stun:stun1.l.google.com:19302" }
                        ] 
                    },
                    sdp_constraints: { 
                        OfferToReceiveAudio: false, 
                        OfferToReceiveVideo: false 
                    },
                    localVideoId: "localVideo",
                    debug: true,  // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­
                    
                    callback: (info, obj) => {
                        addLog(`ğŸ“ callback: ${info}`);
                        if (info === "initialized") {
                            statusEl.textContent = "Ù…ØªØµÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«...";
                            webRTCAdaptor.publish(STREAM_ID);
                            addLog(`ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø« Ù…Ø¹ ID: ${STREAM_ID}`);
                        } else if (info === "publish_started") {
                            statusEl.textContent = "âœ… Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!";
                            statusEl.style.color = "#4CAF50";
                            addLog("ğŸ‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†");
                        } else if (info === "publish_finished") {
                            statusEl.textContent = "Ø§Ù„Ø¨Ø« ØªÙˆÙ‚Ù";
                            statusEl.style.color = "#ff9800";
                            addLog("â¹ Ø§Ù„Ø¨Ø« ØªÙˆÙ‚Ù");
                        } else if (info === "ice_candidate") {
                            addLog("ğŸ”— ICE candidate ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡");
                        }
                    },
                    
                    callbackError: (error, message) => {
                        addLog(`âŒ callbackError: ${error} - ${message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©'}`);
                        statusEl.textContent = `Ø®Ø·Ø£: ${error}`;
                        statusEl.style.color = "#f44336";
                        console.error("Ø®Ø·Ø£ Ù…ÙØµÙ„ Ù…Ù† Adaptor:", error, message);
                    }
                });
                
                addLog("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† WebRTCAdaptor");
                
            } catch (err) {
                addLog(`âŒ ÙØ´Ù„ catch: ${err.name} - ${err.message}`);
                statusEl.textContent = `Ø®Ø·Ø£: ${err.name}`;
                statusEl.style.color = "#f44336";
                
                // ØªØ­Ù„ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù‚ØªØ±Ø§Ø­
                if (err.name === 'NotAllowedError') {
                    addLog("ğŸ’¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­: ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
                } else if (err.name === 'NotFoundError') {
                    addLog("ğŸ’¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø­Ø§ÙˆÙ„ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©.");
                } else if (err.name === 'NotReadableError' || err.name === 'AbortError') {
                    addLog("ğŸ’¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­: Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø±. Ø£ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.");
                } else if (err.name === 'OverconstrainedError') {
                    addLog("ğŸ’¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø¬Ø±Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø¨Ø³Ø·.");
                }
            }
        }

        // ========== Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ==========
        function stopBroadcast() {
            addLog("--- Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ---");
            if (webRTCAdaptor) {
                webRTCAdaptor.stop(STREAM_ID);
                addLog("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¥ÙŠÙ‚Ø§Ù Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…");
            }
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    addLog(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù track: ${track.kind}`);
                });
            }
            localVideo.srcObject = null;
            statusEl.textContent = "Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù";
            statusEl.style.color = "#fff";
        }

        window.addEventListener('beforeunload', stopBroadcast);
        
        // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
        addLog("âœ… Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± 'ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©' Ø£ÙˆÙ„Ø§Ù‹.");
    </script>
</body>
</html>
