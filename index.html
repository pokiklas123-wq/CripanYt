<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 20px;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #f0f0f0;
            text-align: center;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 900px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        h3 {
            margin: 0 0 25px 0;
            color: #4FC3F7;
            font-size: 1.8em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        #localVideo {
            width: 100%; max-width: 640px; height: auto;
            background: #000; border-radius: 12px;
            border: 3px solid #37474F; margin: 15px auto;
            display: block; transform: scaleX(-1);
        }
        .controls {
            margin: 25px 0; display: flex;
            flex-wrap: wrap; justify-content: center;
            gap: 15px;
        }
        button {
            padding: 16px 28px; margin: 5px;
            font-size: 16px; font-weight: bold; border: none;
            border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center;
            justify-content: center; min-width: 180px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        button:active { transform: translateY(0); }
        #btnDevices { background: linear-gradient(45deg, #FF9800, #F57C00); color: #fff; }
        #btnStart { background: linear-gradient(45deg, #4CAF50, #2E7D32); color: #fff; }
        #btnStop { background: linear-gradient(45deg, #F44336, #C62828); color: #fff; }
        #btnStop:disabled { background: #757575; cursor: not-allowed; }
        #status {
            margin: 20px auto; padding: 15px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px; border-right: 5px solid #2196F3;
            font-size: 1.1em; min-height: 24px;
        }
        #log {
            text-align: left; margin: 25px auto; padding: 20px;
            background: rgba(0, 0, 0, 0.7); border-radius: 12px;
            font-family: 'Courier New', monospace; font-size: 13px;
            white-space: pre-wrap; max-height: 300px;
            overflow-y: auto; border: 1px solid #444;
        }
        .log-header {
            display: flex; justify-content: space-between;
            margin-bottom: 10px; color: #AAA;
            font-size: 0.9em;
        }
        #btnClearLog {
            background: transparent; color: #AAA;
            border: 1px solid #666; padding: 5px 15px;
            font-size: 0.9em; min-width: auto;
        }
        .footer {
            margin-top: 30px; color: #AAA; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>ğŸ¥ Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</h3>
        <video id="localVideo" autoplay playsinline muted></video>

        <div class="controls">
            <button id="btnDevices" onclick="listDevices()">
                <span style="margin-left:8px;">ğŸ”</span> ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
            </button>
            <button id="btnStart" onclick="startBroadcast()">
                <span style="margin-left:8px;">â–¶</span> Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            </button>
            <button id="btnStop" onclick="stopBroadcast()" disabled>
                <span style="margin-left:8px;">â¹</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
            </button>
        </div>

        <div id="status">
            â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
        </div>

        <div class="log-header">
            <span>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</span>
            <button id="btnClearLog" onclick="clearLog()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
        <div id="log">[ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø¬Ø§Ø­]</div>

        <div class="footer">
            <p>Ù…Ø´Ø±ÙˆØ¹ ØªØ·ÙˆÙŠØ± Ù…Ù†ØµØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© | Ø¥ØµØ¯Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ v2.1</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="js/adapter.js"></script>
    <script src="https://ant-media-2kbz.onrender.com/live/js/webrtc_adaptor-d838e473.js"></script>
    <!-- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <script>
        // ========== ØªØ´Ø®ÙŠØµ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==========
        console.log("=== Ø¨Ø¯Ø¡ ØªØ´Ø®ÙŠØµ Ø§Ù„ØµÙØ­Ø© ===");
        console.log("1. Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©:", window.location.href);
        console.log("2. ØªÙ… ØªØ­Ù…ÙŠÙ„ adapterØŸ", typeof adapter !== 'undefined' ? "âœ… Ù†Ø¹Ù…" : "âŒ Ù„Ø§");
        console.log("3. ØªÙ… ØªØ­Ù…ÙŠÙ„ WebRTCAdaptorØŸ", typeof WebRTCAdaptor !== 'undefined' ? "âœ… Ù†Ø¹Ù…" : "âŒ Ù„Ø§");

        // ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ==========
        const CONFIG = {
            SERVER_URL: "wss://ant-media-2kbz.onrender.com/live/websocket",
            STREAM_ID: "test_stream_" + Math.floor(Math.random() * 10000),
            MEDIA_CONSTRAINTS: {
                video: {
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 480, max: 720 },
                    frameRate: { ideal: 24, max: 30 },
                    facingMode: "user"
                },
                audio: {
                    channelCount: 1,
                    sampleRate: 44100,
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            },
            ICE_SERVERS: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ]
        };

        let webRTCAdaptor = null;
        let localStream = null;
        let isBroadcasting = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT = 3;

        // Ø¹Ù†Ø§ØµØ± DOM
        let statusEl, logEl, localVideo, btnStart, btnStop, btnDevices;

        // ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© ==========
        function addLog(message) {
            const time = new Date().toLocaleTimeString('ar-EG');
            const logEntry = `[${time}] ${message}`;
            logEl.innerHTML += logEntry + "<br>";
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logEntry);
        }

        function updateStatus(message, type = "info") {
            statusEl.textContent = message;
            const colors = { info: "#4FC3F7", success: "#4CAF50", error: "#F44336", warning: "#FF9800" };
            statusEl.style.borderRightColor = colors[type] || colors.info;
            statusEl.style.color = colors[type] || colors.info;
        }

        function showError(errorMsg) {
            updateStatus(`âŒ Ø®Ø·Ø£: ${errorMsg}`, "error");
            addLog(`âŒ Ø®Ø·Ø£ Ø­Ø±Ø¬: ${errorMsg}`);
            if(btnStart) btnStart.disabled = true;
        }

        function clearLog() {
            logEl.innerHTML = "[ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„]<br>";
            addLog("ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
        }

        // ========== Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© - Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªØ´Ø®ÙŠØµ ==========
        function initPage() {
            console.log("=== Ø¨Ø¯Ø¡ initPage ===");
            
            // Ø±Ø¨Ø· Ø¹Ù†Ø§ØµØ± DOM Ø¨Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            statusEl = document.getElementById('status');
            logEl = document.getElementById('log');
            localVideo = document.getElementById('localVideo');
            btnStart = document.getElementById('btnStart');
            btnStop = document.getElementById('btnStop');
            btnDevices = document.getElementById('btnDevices');
            
            console.log("4. Ø¹Ù†Ø§ØµØ± DOM:", { statusEl, logEl, localVideo, btnStart, btnStop, btnDevices });

            // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
            addLog("ğŸ”§ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...");
            console.log("5. Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª...");

            // Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© - Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±
            if (typeof adapter === 'undefined') {
                console.error("âŒ Ù…ÙƒØªØ¨Ø© adapter ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©!");
                showError("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© WebRTC Adapter.");
                return;
            } else {
                console.log("âœ… Ù…ÙƒØªØ¨Ø© adapter Ù…Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
            }

            if (typeof WebRTCAdaptor === 'undefined') {
                console.error("âŒ Ù…ÙƒØªØ¨Ø© WebRTCAdaptor ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©!");
                console.log("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©:", Object.keys(window).filter(k => k.includes('WebRTC') || k.includes('Adaptor')));
                showError("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ant Media Adaptor. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.");
                return;
            } else {
                console.log("âœ… Ù…ÙƒØªØ¨Ø© WebRTCAdaptor Ù…Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„Ù†ÙˆØ¹:", typeof WebRTCAdaptor);
            }

            addLog("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
            addLog(`ğŸŒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${CONFIG.SERVER_URL}`);
            addLog(`ğŸ“¼ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: ${CONFIG.STREAM_ID}`);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            updateStatus("âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø£ÙˆÙ„Ø§Ù‹.", "success");
            if(btnStart) btnStart.disabled = false;
            if(btnDevices) btnDevices.disabled = false;
            
            console.log("=== Ø§Ù†ØªÙ‡Ø§Ø¡ initPage Ø¨Ù†Ø¬Ø§Ø­ ===");
        }

        // ========== Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ==========
        async function listDevices() {
            console.log("ØªØ´ØºÙŠÙ„ listDevices...");
            updateStatus("ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©...", "info");
            addLog("--- Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ---");

            try {
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø£ÙˆÙ„Ø§Ù‹
                const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                tempStream.getTracks().forEach(track => track.stop());

                const devices = await navigator.mediaDevices.enumerateDevices();
                let hasVideo = false, hasAudio = false;

                devices.forEach(device => {
                    const icon = device.kind === 'videoinput' ? 'ğŸ“¹' :
                                 device.kind === 'audioinput' ? 'ğŸ¤' :
                                 device.kind === 'audiooutput' ? 'ğŸ”Š' : 'ğŸ“Ÿ';
                    addLog(`${icon} ${device.kind}: ${device.label || 'Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù'} (${device.deviceId.substring(0, 10)}...)`);
                    if (device.kind === 'videoinput') hasVideo = true;
                    if (device.kind === 'audioinput') hasAudio = true;
                });

                if (!hasVideo) addLog("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§!");
                if (!hasAudio) addLog("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†!");

                updateStatus(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${devices.length} Ø¬Ù‡Ø§Ø²`, hasVideo && hasAudio ? "success" : "warning");
                if(btnStart) btnStart.disabled = !(hasVideo && hasAudio);

            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ listDevices:", err);
                addLog(`âŒ ÙØ´Ù„ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©: ${err.name} - ${err.message}`);
                updateStatus("âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©", "error");
                if(btnStart) btnStart.disabled = true;
            }
        }

        // ========== Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« ==========
        async function startBroadcast() {
            console.log("ØªØ´ØºÙŠÙ„ startBroadcast...");
            if (isBroadcasting) {
                updateStatus("âš ï¸ Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!", "warning");
                return;
            }

            updateStatus("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...", "info");
            addLog("--- Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« ---");
            addLog(`ğŸ“¤ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${CONFIG.SERVER_URL}`);

            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            if(btnStart) btnStart.disabled = true;
            if(btnStop) btnStop.disabled = false;

            try {
                // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯ÙÙ‚ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
                updateStatus("ğŸ“· Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...", "info");
                addLog(`Ø·Ù„Ø¨ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ${JSON.stringify(CONFIG.MEDIA_CONSTRAINTS)}`);

                localStream = await navigator.mediaDevices.getUserMedia(CONFIG.MEDIA_CONSTRAINTS);

                const videoTrack = localStream.getVideoTracks()[0];
                const audioTrack = localStream.getAudioTracks()[0];
                addLog(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: ${videoTrack.label || 'ÙƒØ§Ù…ÙŠØ±Ø§'} & ${audioTrack.label || 'Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†'}`);

                // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                localVideo.srcObject = localStream;
                updateStatus("ğŸ¥ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ¹Ù…Ù„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...", "info");

                // 3. Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† WebRTCAdaptor
                addLog("ğŸ”Œ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebSocket Ù…Ø¹ Ø®Ø§Ø¯Ù… Ant Media...");

                webRTCAdaptor = new WebRTCAdaptor({
                    websocket_url: CONFIG.SERVER_URL,
                    mediaConstraints: { video: true, audio: true },
                    peerconnection_config: { iceServers: CONFIG.ICE_SERVERS },
                    sdp_constraints: { OfferToReceiveAudio: false, OfferToReceiveVideo: false },
                    localVideoId: "localVideo",
                    debug: true,

                    callback: (info, obj) => {
                        addLog(`ğŸ“ [Callback] ${info}`);
                        console.log("Callback from WebRTCAdaptor:", info);

                        switch(info) {
                            case "initialized":
                                updateStatus("ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«...", "info");
                                webRTCAdaptor.publish(CONFIG.STREAM_ID);
                                addLog(`ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù†Ø´Ø± Ø§Ù„Ø¨Ø« Ø¨Ø§Ø³Ù…: ${CONFIG.STREAM_ID}`);
                                break;

                            case "publish_started":
                                isBroadcasting = true;
                                updateStatus("âœ… Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!", "success");
                                addLog("ğŸ‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ÙˆÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡ Ù…Ù† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†.");
                                reconnectAttempts = 0;
                                break;

                            case "publish_finished":
                                isBroadcasting = false;
                                updateStatus("â¹ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«", "info");
                                addLog("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ.");
                                resetUI();
                                break;

                            case "closed":
                                addLog("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebSocket.");
                                if (isBroadcasting && reconnectAttempts < MAX_RECONNECT) {
                                    reconnectAttempts++;
                                    addLog(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (${reconnectAttempts}/${MAX_RECONNECT})...`);
                                    setTimeout(() => {
                                        if (webRTCAdaptor) webRTCAdaptor.close();
                                        startBroadcast();
                                    }, 2000);
                                }
                                break;

                            default:
                                addLog(`Ø­Ø¯Ø« ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬: ${info}`);
                        }
                    },

                    callbackError: (error, message) => {
                        addLog(`âŒ [Error Callback] ${error} - ${message || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„'}`);
                        console.error("Error from WebRTCAdaptor:", error, message);
                        updateStatus(`Ø®Ø·Ø£: ${error}`, "error");

                        if (error === "no_stream_exist") {
                            addLog("ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù… ÙŠØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙÙ‚. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© STREAM_ID.");
                        }
                        if (error === "websocket_closed") {
                            if (reconnectAttempts < MAX_RECONNECT) {
                                addLog(`ğŸ”„ Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...`);
                            }
                        }
                    }
                });

                addLog("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† WebRTCAdaptor Ø¨Ù†Ø¬Ø§Ø­.");

            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ startBroadcast:", err);
                addLog(`âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«: ${err.name} - ${err.message}`);
                updateStatus(`âŒ ÙØ´Ù„: ${err.name}`, "error");
                resetUI();

                if (err.name === 'NotAllowedError') {
                    addLog("ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.");
                } else if (err.name === 'NotFoundError') {
                    addLog("ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¹Ø§Ù…Ù„ÙŠÙ†.");
                } else if (err.name === 'NotReadableError') {
                    addLog("ğŸ’¡ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø´ØºÙˆÙ„. Ø£ØºÙ„Ù‚ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¢Ø®Ø± ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.");
                }
            }
        }

        // ========== Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ==========
        function stopBroadcast() {
            console.log("ØªØ´ØºÙŠÙ„ stopBroadcast...");
            if (!isBroadcasting && !webRTCAdaptor) {
                updateStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø· Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡", "warning");
                return;
            }

            addLog("--- Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ---");
            updateStatus("â¹ Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«...", "info");

            if (webRTCAdaptor) {
                webRTCAdaptor.stop(CONFIG.STREAM_ID);
                webRTCAdaptor.close();
                webRTCAdaptor = null;
                addLog("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù„Ù„Ø®Ø§Ø¯Ù… ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„.");
            }

            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    addLog(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø³Ø§Ø± ${track.kind}`);
                });
                localStream = null;
            }

            localVideo.srcObject = null;
            isBroadcasting = false;
            updateStatus("âœ… Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.", "info");
            resetUI();
            addLog("âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯.");
        }

        // ========== Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        function resetUI() {
            if(btnStart) btnStart.disabled = false;
            if(btnStop) btnStop.disabled = true;
            reconnectAttempts = 0;
        }

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±Ø© Ø­ÙŠØ§Ø© Ø§Ù„ØµÙØ­Ø© ==========
        window.addEventListener('beforeunload', (event) => {
            if (isBroadcasting) {
                addLog("âš ï¸ ØªØ­Ø°ÙŠØ±: ØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø«!");
                stopBroadcast();
                event.preventDefault();
                event.returnValue = 'ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
            }
        });

        // ØªØ£Ø®ÙŠØ± ØªØ­Ù…ÙŠÙ„ initPage Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        window.addEventListener('load', () => {
            console.log("Ø­Ø¯Ø« load ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ØŒ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ initPage Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·...");
            setTimeout(initPage, 100);
        });

        // ========== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ==========
        function getViewerLink() {
            const link = `https://ant-media-2kbz.onrender.com/live/player.html?streamId=${CONFIG.STREAM_ID}`;
            addLog(`ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©: ${link}`);
            updateStatus(`Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ø§Ù‡Ø² ÙÙŠ Ø§Ù„Ø³Ø¬Ù„`, "info");
            return link;
        }

        window.getViewerLink = getViewerLink;

        console.log("=== ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ JavaScript Ø¨Ù†Ø¬Ø§Ø­ ===");
    </script>
</body>
        </html>
