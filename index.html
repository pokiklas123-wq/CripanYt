<!DOCTYPE html>
<html>
<head>
    <title>Ø§Ù„Ù…Ø°ÙŠØ¹</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        video { width: 100%; max-width: 600px; background: #000; }
        button { padding: 10px 20px; margin: 5px; }
        #status { padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¥ Ø§Ù„Ù…Ø°ÙŠØ¹</h1>
    
    <div>
        <input type="text" id="roomId" value="live1" placeholder="Room ID">
        <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
        <button id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
    
    <div id="status">Ø¬Ø§Ù‡Ø²</div>
    
    <video id="localVideo" autoplay muted playsinline></video>
    <div>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙˆÙ†: <span id="viewerCount">0</span></div>
    
    <script>
        const SERVER = 'wss://cripanyt.onrender.com';
        let localStream;
        let peerConnections = new Map();
        let socket;
        let roomId;
        
        document.getElementById('startBtn').onclick = startBroadcast;
        document.getElementById('stopBtn').onclick = stopBroadcast;
        
        async function startBroadcast() {
            roomId = document.getElementById('roomId').value;
            if (!roomId) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©');
            
            try {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„ØµÙˆØª
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                
                // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
                socket = new WebSocket(SERVER);
                
                socket.onopen = () => {
                    socket.send(JSON.stringify({
                        type: 'create-room',
                        roomId: roomId
                    }));
                    document.getElementById('status').textContent = 'Ø§Ù„Ø¨Ø« Ø¬Ø§Ù‡Ø²';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                };
                
                socket.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'room-created') {
                        console.log('âœ… Room created');
                    }
                    else if (data.type === 'viewer-joined') {
                        document.getElementById('viewerCount').textContent = data.total;
                        createPeerConnection(data.viewerId);
                    }
                    else if (data.type === 'answer') {
                        const pc = peerConnections.get(data.viewerId);
                        if (pc) {
                            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
                        }
                    }
                    else if (data.type === 'ice-candidate') {
                        const pc = peerConnections.get(data.viewerId);
                        if (pc) {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    }
                };
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function createPeerConnection(viewerId) {
            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });
            
            // Ø¥Ø¶Ø§ÙØ© ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
            
            // Ø¥Ø±Ø³Ø§Ù„ ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate && socket.readyState === 1) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: roomId
                    }));
                }
            };
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'offer',
                        sdp: pc.localDescription,
                        roomId: roomId
                    }));
                });
            
            peerConnections.set(viewerId, pc);
        }
        
        function stopBroadcast() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if (socket) {
                socket.close();
            }
            
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'Ù…ØªÙˆÙ‚Ù';
            document.getElementById('viewerCount').textContent = '0';
        }
    </script>
</body>
</html>
