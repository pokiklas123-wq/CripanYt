<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        /* Ù†ÙØ³ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 20px;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #f0f0f0;
            text-align: center;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 900px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }
        h3 { margin: 0 0 25px 0; color: #4FC3F7; font-size: 1.8em; }
        #localVideo {
            width: 100%; max-width: 640px; height: auto;
            background: #000; border-radius: 12px;
            border: 3px solid #37474F; margin: 15px auto;
            display: block; transform: scaleX(-1);
        }
        .controls {
            margin: 25px 0; display: flex;
            flex-wrap: wrap; justify-content: center;
            gap: 15px;
        }
        button {
            padding: 16px 28px; margin: 5px;
            font-size: 16px; font-weight: bold; border: none;
            border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center;
            justify-content: center; min-width: 180px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        #btnDevices { background: linear-gradient(45deg, #FF9800, #F57C00); color: #fff; }
        #btnStart { background: linear-gradient(45deg, #4CAF50, #2E7D32); color: #fff; }
        #btnStop { background: linear-gradient(45deg, #F44336, #C62828); color: #fff; }
        #btnStop:disabled { background: #757575; cursor: not-allowed; }
        #status {
            margin: 20px auto; padding: 15px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px; border-right: 5px solid #2196F3;
            font-size: 1.1em; min-height: 24px;
        }
        #log {
            text-align: left; margin: 25px auto; padding: 20px;
            background: rgba(0, 0, 0, 0.7); border-radius: 12px;
            font-family: 'Courier New', monospace; font-size: 13px;
            white-space: pre-wrap; max-height: 300px;
            overflow-y: auto; border: 1px solid #444;
        }
        .footer { margin-top: 30px; color: #AAA; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h3>ğŸ¥ Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø§Ù„Ø­Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠ</h3>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="controls">
            <button id="btnDevices">ğŸ” ÙØ­Øµ</button>
            <button id="btnStart">â–¶ Ø¨Ø«</button>
            <button id="btnStop" disabled>â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
        <div id="status">âš™ï¸ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¬Ù…Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
        <div id="log">[Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠ]</div>
        <div class="footer">
            <p>Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ³ØªØ®Ø¯Ù… webrtc_adaptor-d838e473.js Ù…Ø¨Ø§Ø´Ø±Ø©</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@latest"></script>
    
    <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¬Ù…Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© - Ù‡Ø°Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ù…Ù„ -->
    <script src="https://cripanyt-production.up.railway.app/live/js/webrtc_adaptor-d838e473.js"></script>

    <script>
        // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ==========
        document.addEventListener('DOMContentLoaded', function() {
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const localVideo = document.getElementById('localVideo');
            const btnDevices = document.getElementById('btnDevices');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            
            let logMessages = [];
            
            function addLog(msg) {
                const time = new Date().toLocaleTimeString('ar-EG');
                const logMsg = `[${time}] ${msg}`;
                logMessages.push(logMsg);
                logEl.innerHTML = logMessages.join('<br>');
            }
            
            addLog('ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§ Ø¥Ø°Ø§ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
            setTimeout(() => {
                // Ø§Ø¨Ø­Ø« Ø¹Ù† WebRTCAdaptor Ø¨Ø£ÙŠ Ø·Ø±ÙŠÙ‚Ø©
                let WebRTCAdaptorFound = null;
                
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: Ø§Ø¨Ø­Ø« ÙÙŠ window
                if (window.WebRTCAdaptor) {
                    WebRTCAdaptorFound = window.WebRTCAdaptor;
                    addLog('âœ… ÙˆØ¬Ø¯Øª WebRTCAdaptor ÙÙŠ window');
                }
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: Ø§Ø¨Ø­Ø« ÙƒÙƒØ§Ø¦Ù† W (Ù„Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¬Ù…Ø¹)
                else if (window.W) {
                    window.WebRTCAdaptor = window.W;
                    WebRTCAdaptorFound = window.W;
                    addLog('âœ… ÙˆØ¬Ø¯Øª W ÙˆØ­ÙˆÙ„ØªÙ‡Ø§ Ø¥Ù„Ù‰ WebRTCAdaptor');
                }
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 3: Ø§Ø¨Ø­Ø« ÙÙŠ global scope
                else {
                    // Ø¬Ø±Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø£Ø®Ø±Ù‰ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    const possibleNames = ['WebRTCAdaptor', 'W', 'AntMediaWebRTC', 'webRTCAdaptor'];
                    for (const name of possibleNames) {
                        if (window[name]) {
                            window.WebRTCAdaptor = window[name];
                            WebRTCAdaptorFound = window[name];
                            addLog(`âœ… ÙˆØ¬Ø¯Øª ${name} ÙˆØ§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§`);
                            break;
                        }
                    }
                }
                
                if (WebRTCAdaptorFound) {
                    statusEl.textContent = 'âœ… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ø­Ù…Ù„Ø© ÙˆØ¬Ø§Ù‡Ø²Ø©';
                    statusEl.style.borderRightColor = '#4CAF50';
                    btnStart.disabled = false;
                    
                    addLog('ğŸ‘‰ Ø§Ø¶ØºØ· "ÙØ­Øµ" Ø«Ù… "Ø¨Ø«"');
                    
                    // Ø§Ù„Ø¢Ù† Ù‚Ù… Ø¨ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„
                    initFunctions(WebRTCAdaptorFound);
                } else {
                    statusEl.textContent = 'âŒ Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø©';
                    addLog('âŒ Ø§ÙØªØ­ Console ÙˆØ§ÙƒØªØ¨: console.log(window.W) Ø£Ùˆ console.log(window.WebRTCAdaptor)');
                    addLog('âŒ Ø«Ù… Ø£Ø±Ø³Ù„ Ù„ÙŠ Ù…Ø§ ÙŠØ¸Ù‡Ø±');
                }
            }, 1000);
            
            function initFunctions(WebRTCAdaptor) {
                let localStream = null;
                let webRTCAdaptorInstance = null;
                let isBroadcasting = false;
                
                const CONFIG = {
                    SERVER_URL: "wss://cripanyt-production.up.railway.app/live/websocket",
                    STREAM_ID: "practical_" + Date.now()
                };
                
                // ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                btnDevices.onclick = async function() {
                    try {
                        statusEl.textContent = 'ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©...';
                        localStream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        localVideo.srcObject = localStream;
                        statusEl.textContent = 'âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„';
                        addLog('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
                    } catch (err) {
                        addLog(`âŒ Ø®Ø·Ø£: ${err.message}`);
                        statusEl.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø©';
                    }
                };
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
                btnStart.onclick = async function() {
                    if (isBroadcasting) {
                        statusEl.textContent = 'âš ï¸ Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„';
                        return;
                    }
                    
                    statusEl.textContent = 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«...';
                    addLog('--- Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« ---');
                    
                    btnStart.disabled = true;
                    btnStop.disabled = false;
                    
                    try {
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ streamØŒ Ø§Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡
                        if (!localStream) {
                            localStream = await navigator.mediaDevices.getUserMedia({
                                video: { facingMode: "user" },
                                audio: true
                            });
                            localVideo.srcObject = localStream;
                        }
                        
                        addLog(`ğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„: ${CONFIG.SERVER_URL}`);
                        
                        // Ø£Ù†Ø´Ø¦ Ù†Ø³Ø®Ø© Ù…Ù† WebRTCAdaptor
                        webRTCAdaptorInstance = new WebRTCAdaptor({
                            websocket_url: CONFIG.SERVER_URL,
                            mediaConstraints: { video: true, audio: true },
                            peerconnection_config: {
                                iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                            },
                            sdp_constraints: {
                                OfferToReceiveAudio: false,
                                OfferToReceiveVideo: false
                            },
                            localVideoId: "localVideo",
                            debug: false,
                            
                            callback: function(info, obj) {
                                addLog(`ğŸ“ ${info}`);
                                
                                if (info === "initialized") {
                                    statusEl.textContent = "ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...";
                                    webRTCAdaptorInstance.publish(CONFIG.STREAM_ID);
                                    addLog(`ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¨Ø«: ${CONFIG.STREAM_ID}`);
                                } 
                                else if (info === "publish_started") {
                                    isBroadcasting = true;
                                    statusEl.textContent = "âœ… Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„!";
                                    addLog("ğŸ‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†!");
                                    addLog("ğŸ‘‰ Ø§ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„ØªØ­Ù‚Ù‚");
                                }
                                else if (info === "publish_finished") {
                                    isBroadcasting = false;
                                    statusEl.textContent = "â¹ ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«";
                                    btnStart.disabled = false;
                                    btnStop.disabled = true;
                                }
                            },
                            
                            callbackError: function(error, message) {
                                addLog(`âŒ Ø®Ø·Ø£: ${error} - ${message || 'Ù„Ø§ ØªÙØ§ØµÙŠÙ„'}`);
                                statusEl.textContent = `âŒ ${error}`;
                                
                                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø¬Ø±Ø¨ https Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† wss
                                if (error.includes("websocket") || error.includes("WebSocket")) {
                                    addLog("ğŸ’¡ Ø¬Ø±Ø¨: const CONFIG.SERVER_URL = 'https://...websocket'");
                                }
                            }
                        });
                        
                    } catch (err) {
                        addLog(`âŒ ÙØ´Ù„: ${err.message}`);
                        statusEl.textContent = 'âŒ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«';
                        btnStart.disabled = false;
                        btnStop.disabled = true;
                    }
                };
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
                btnStop.onclick = function() {
                    if (!isBroadcasting) return;
                    
                    addLog('--- Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ---');
                    statusEl.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«...';
                    
                    if (webRTCAdaptorInstance) {
                        webRTCAdaptorInstance.stop(CONFIG.STREAM_ID);
                        webRTCAdaptorInstance.close();
                        webRTCAdaptorInstance = null;
                    }
                    
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    
                    localVideo.srcObject = null;
                    isBroadcasting = false;
                    statusEl.textContent = 'âœ… Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù';
                    
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                };
            }
        });
    </script>
</body>
</html>
