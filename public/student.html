<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙŠØ¯)</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { margin: 0; padding: 10px; background: #000; color: white; }
        .header {
            text-align: center; padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px; margin-bottom: 10px;
        }
        .live-badge {
            background: #ff0000; color: white; padding: 5px 15px;
            border-radius: 20px; display: inline-block;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }
        .video-container {
            width: 100%; max-width: 1200px; margin: auto;
            background: #000; border-radius: 10px; overflow: hidden;
            position: relative;
        }
        canvas { width: 100%; max-height: 70vh; background: #000; }
        .loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); text-align: center;
            color: white; background: rgba(0,0,0,0.7);
            padding: 20px; border-radius: 10px;
            z-index: 10;
        }
        .controls { text-align: center; margin: 15px 0; }
        button {
            background: #1a73e8; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer;
        }
        .status {
            text-align: center; padding: 10px; margin: 10px 0;
            border-radius: 5px; background: rgba(255,255,255,0.1);
        }
        .connected { background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; }
        .disconnected { background: rgba(244,67,54,0.2); border: 2px solid #F44336; }
        .waiting { background: rgba(255,193,7,0.2); border: 2px solid #FFC107; }
        .info-box {
            background: rgba(255,255,255,0.05);
            padding: 10px; border-radius: 5px;
            margin: 10px 0; text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="live-badge">â— Ù…Ø¨Ø§Ø´Ø±</div>
        <h2>ğŸ“š Ø§Ù„Ø¨Ø« Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙŠØ¯)</h2>
        <div class="status disconnected" id="status">ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    </div>
    
    <div class="video-container">
        <div class="loading" id="loading">
            <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
            <p id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...</p>
            <p style="font-size: 12px; color: #aaa; margin-top: 10px;" id="connectionInfo">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø«...
            </p>
            <button onclick="connectToBroadcast()" style="margin-top: 15px; background: #1a73e8;">
                ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            </button>
        </div>
        <canvas id="videoCanvas"></canvas>
    </div>
    
    <div class="info-box" id="broadcastInfo" style="display: none;">
        <p>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³: <span id="teacherStatus">Ù†Ø´Ø·</span></p>
        <p>ğŸ”„ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">Ø§Ù„Ø¢Ù†</span></p>
        <p>ğŸ“Š Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«: <span id="quality">Ø¬ÙŠØ¯Ø©</span></p>
    </div>
    
    <div class="controls">
        <button onclick="toggleFullscreen()">ğŸ“º Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
        <button onclick="toggleAutoRefresh()" id="autoRefreshBtn">ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„</button>
        <button onclick="checkBroadcastStatus()" id="checkBtn">ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«</button>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #888; font-size: 12px;">
        <p>ğŸ”Š ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª | ğŸ“± ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
        <p>ğŸ’¡ <strong>Ù…Ø¹Ù„ÙˆÙ…Ø©:</strong> Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† WebSocket - Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹</p>
    </div>

    <script>
        let canvas, ctx;
        let broadcastInterval;
        let autoRefresh = true;
        let lastFrameTime = 0;
        let connectionAttempts = 0;
        let roomId;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('room');
            
            if (!id) {
                showError('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¨Ø«.');
                return null;
            }
            
            return id;
        }
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«
        function connectToBroadcast() {
            roomId = getRoomId();
            if (!roomId) return;
            
            connectionAttempts++;
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Canvas
            canvas = document.getElementById('videoCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 480;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            updateStatus('ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø«...', 'waiting');
            document.getElementById('loadingText').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø«...';
            document.getElementById('connectionInfo').textContent = `Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${connectionAttempts}`;
            
            // Ø·Ù„Ø¨ Ø£ÙˆÙ„ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ø«
            checkBroadcastStatus();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø« Ù†Ø´Ø·Ø§Ù‹
            if (autoRefresh) {
                startBroadcastPolling();
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«
        function checkBroadcastStatus() {
            if (!roomId) return;
            
            fetch(`/student/stream?roomId=${roomId}&t=${Date.now()}`)
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', data.status);
                    
                    if (data.status === 'active' && data.frame) {
                        // Ø§Ù„Ø¨Ø« Ù†Ø´Ø· ÙˆÙ‡Ù†Ø§Ùƒ Ø¥Ø·Ø§Ø±
                        updateStatus('ğŸŸ¢ Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«', 'connected');
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('broadcastInfo').style.display = 'block';
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø·Ø§Ø±
                        displayVideoFrame(data.frame);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                        updateBroadcastInfo(data);
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                        connectionAttempts = 0;
                        
                    } else if (data.status === 'waiting') {
                        // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
                        updateStatus('ğŸŸ¡ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³...', 'waiting');
                        document.getElementById('loading').style.display = 'block';
                        document.getElementById('loadingText').textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¨Ø«...';
                        document.getElementById('connectionInfo').textContent = 
                            'ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« ÙˆØ£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­';
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                        if (connectionAttempts < 10) {
                            setTimeout(checkBroadcastStatus, 3000);
                        }
                        
                    } else if (data.status === 'ended') {
                        // Ø§Ù„Ø¨Ø« Ø§Ù†ØªÙ‡Ù‰
                        showBroadcastEnded();
                    }
                })
                .catch(error => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    
                    if (connectionAttempts < 5) {
                        updateStatus('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...', 'disconnected');
                        setTimeout(checkBroadcastStatus, 2000);
                    } else {
                        showError('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù†:<br>' +
                                 '1. Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª<br>' +
                                 '2. Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­<br>' +
                                 '3. Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«');
                    }
                });
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¹Ù† Ø§Ù„Ø¨Ø«
        function startBroadcastPolling() {
            if (broadcastInterval) {
                clearInterval(broadcastInterval);
            }
            
            broadcastInterval = setInterval(() => {
                if (!roomId) return;
                
                fetch(`/student/stream?roomId=${roomId}&t=${Date.now()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'active' && data.frame) {
                            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø·Ø§Ø±
                            displayVideoFrame(data.frame);
                            updateBroadcastInfo(data);
                            lastFrameTime = Date.now();
                        } else if (data.status === 'ended') {
                            showBroadcastEnded();
                            clearInterval(broadcastInterval);
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', error);
                    });
                    
            }, 1000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        }
        
        // Ø¹Ø±Ø¶ Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        function displayVideoFrame(frameData) {
            if (!frameData) return;
            
            try {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.onerror = () => {
                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø«');
                };
                img.src = frameData;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', error);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø«
        function updateBroadcastInfo(data) {
            const now = Date.now();
            const lastUpdate = data.timestamp;
            const diff = now - lastUpdate;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
            let timeText = 'Ø§Ù„Ø¢Ù†';
            if (diff > 1000) {
                const seconds = Math.floor(diff / 1000);
                timeText = `Ù‚Ø¨Ù„ ${seconds} Ø«Ø§Ù†ÙŠØ©`;
            }
            
            document.getElementById('lastUpdate').textContent = timeText;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
            const teacherStatus = diff < 5000 ? 'Ù†Ø´Ø·' : (diff < 10000 ? 'Ø¨Ø·ÙŠØ¡' : 'ØºÙŠØ± Ù…ØªØµÙ„');
            document.getElementById('teacherStatus').textContent = teacherStatus;
            
            // ØªØ­Ø¯ÙŠØ« Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«
            const frameCount = data.frameCount || 0;
            const quality = frameCount > 5 ? 'Ù…Ù…ØªØ§Ø²Ø©' : (frameCount > 2 ? 'Ø¬ÙŠØ¯Ø©' : 'Ø¶Ø¹ÙŠÙØ©');
            document.getElementById('quality').textContent = quality;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateStatus(message, className) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + className;
        }
        
        // Ø¹Ø±Ø¶ Ø®Ø·Ø£
        function showError(message) {
            updateStatus(message, 'disconnected');
            document.getElementById('loadingText').innerHTML = message;
            document.getElementById('loading').style.display = 'block';
        }
        
        // Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø«
        function showBroadcastEnded() {
            updateStatus('â¹ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', 'disconnected');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingText').innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ</div>
                <p>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
                <p>Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ø¨Ø¯Ø¡ Ø¨Ø« Ø¬Ø¯ÙŠØ¯</p>
            `;
            document.getElementById('broadcastInfo').style.display = 'none';
            
            if (broadcastInterval) {
                clearInterval(broadcastInterval);
            }
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
        function toggleFullscreen() {
            const container = document.querySelector('.video-container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            autoRefresh = !autoRefresh;
            
            if (autoRefresh) {
                btn.textContent = 'ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ØªØ´ØºÙŠÙ„';
                startBroadcastPolling();
            } else {
                btn.textContent = 'ğŸ”„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø¥ÙŠÙ‚Ø§Ù';
                if (broadcastInterval) {
                    clearInterval(broadcastInterval);
                }
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            console.log('ğŸš€ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø© (Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙŠØ¯)');
            connectToBroadcast();
        };
    </script>
</body>
</html>
