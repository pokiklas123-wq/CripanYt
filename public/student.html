<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 30px; background: rgba(255,255,255,0.1); border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        h1 { color: #FFD700; font-size: 2.8rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .subtitle { color: #aaa; font-size: 1.2rem; margin-bottom: 20px; }
        .live-indicator { background: linear-gradient(45deg, #ff0000, #ff6b6b); color: white; padding: 12px 30px; border-radius: 30px; font-size: 1.3rem; font-weight: bold; display: inline-block; animation: pulse 1.5s infinite; box-shadow: 0 0 20px rgba(255,0,0,0.5); letter-spacing: 1px; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 20px rgba(255,0,0,0.5); } 50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(255,0,0,0.7); } 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,0,0,0.5); } }
        .video-container { position: relative; width: 100%; background: #000; border-radius: 20px; overflow: hidden; margin: 30px 0; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 3px solid rgba(255,255,255,0.1); }
        video { width: 100%; height: auto; min-height: 600px; display: block; }
        .overlay { position: absolute; top: 30px; left: 30px; background: rgba(0,0,0,0.8); padding: 15px 25px; border-radius: 15px; display: flex; align-items: center; gap: 15px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .status-dot { width: 15px; height: 15px; background: #ff0000; border-radius: 50%; animation: statusPulse 2s infinite; }
        @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.85); padding: 50px; border-radius: 20px; width: 80%; max-width: 500px; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.1); z-index: 10; }
        .loading-spinner { width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 25px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .controls { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        button { background: linear-gradient(45deg, #1a73e8, #0d47a1); color: white; border: none; padding: 18px 35px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 25px rgba(26,115,232,0.3); display: flex; align-items: center; gap: 12px; font-weight: bold; }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(26,115,232,0.4); }
        button:active { transform: translateY(1px); }
        .audio-btn { background: linear-gradient(45deg, #34a853, #2d9450); }
        .refresh-btn { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .info-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin: 40px 0; }
        .info-card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .info-card h3 { color: #FFD700; margin-bottom: 15px; font-size: 1.4rem; }
        .info-value { font-size: 2.2rem; font-weight: bold; color: white; margin: 10px 0; }
        .connection-status { padding: 25px; border-radius: 15px; margin: 25px 0; text-align: center; font-size: 1.3rem; font-weight: bold; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .connected { background: linear-gradient(45deg, rgba(76,175,80,0.3), rgba(46,125,50,0.3)); border-color: #4CAF50; }
        .disconnected { background: linear-gradient(45deg, rgba(244,67,54,0.3), rgba(198,40,40,0.3)); border-color: #F44336; }
        .waiting { background: linear-gradient(45deg, rgba(255,193,7,0.3), rgba(255,152,0,0.3)); border-color: #FFC107; }
        .footer { text-align: center; margin-top: 50px; color: #888; font-size: 0.9rem; padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        @media (max-width: 768px) { h1 { font-size: 2rem; } .controls { flex-direction: column; align-items: center; } button { width: 90%; justify-content: center; } video { min-height: 400px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="live-indicator">â— Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</div>
            <h1>ğŸ“š Ø§Ù„Ø¨Ø« Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
            <p class="subtitle">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³ - Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</p>
        </div>
        
        <div class="connection-status disconnected" id="connectionStatus">
            ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...
        </div>
        
        <div class="video-container">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <h3 style="color: white; margin-bottom: 15px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                <p id="loadingText" style="color: #aaa; margin-bottom: 25px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ†Ù…Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³...</p>
                <button onclick="reconnect()" style="background: linear-gradient(45deg, #1a73e8, #0d47a1); padding: 15px 30px; font-size: 1rem;">
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
            <div class="overlay">
                <div class="status-dot"></div>
                <span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</span>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        
        <div class="controls">
            <button onclick="toggleFullscreen()">
                <span>ğŸ“º</span>
                <span>Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</span>
            </button>
            <button onclick="toggleAudio()" id="audioBtn" class="audio-btn">
                <span>ğŸ”Š</span>
                <span>Ø§Ù„ØµÙˆØª</span>
            </button>
            <button onclick="reconnect()" class="refresh-btn">
                <span>ğŸ”„</span>
                <span>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„</span>
            </button>
        </div>
        
        <div class="info-panel">
            <div class="info-card">
                <h3>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³</h3>
                <div class="info-value" id="teacherStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
                <p>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³</p>
            </div>
            <div class="info-card">
                <h3>ğŸ“¶ Ø§Ù„Ø¬ÙˆØ¯Ø©</h3>
                <div class="info-value" id="streamQuality">--</div>
                <p>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
            </div>
            <div class="info-card">
                <h3>ğŸ• Ø§Ù„Ù…Ø¯Ø©</h3>
                <div class="info-value" id="broadcastTime">00:00</div>
                <p>Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p>
            </div>
            <div class="info-card">
                <h3>ğŸŒ Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                <div class="info-value" id="networkStatus">--</div>
                <p>Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©</p>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ”Š ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª | ğŸ“± ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© | âš¡ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ØªØµÙØ­ Ø­Ø¯ÙŠØ«</p>
            <p>Ù„Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©: Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</p>
        </div>
    </div>

    <script>
        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const remoteVideo = document.getElementById('remoteVideo');
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const teacherStatus = document.getElementById('teacherStatus');
        const streamQuality = document.getElementById('streamQuality');
        const broadcastTime = document.getElementById('broadcastTime');
        const networkStatus = document.getElementById('networkStatus');
        const audioBtn = document.getElementById('audioBtn');
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        let peerConnection = null;
        let ws = null;
        let roomId = null;
        let isConnected = false;
        let startTime = null;
        let audioMuted = false;
        let connectionAttempts = 0;
        const MAX_ATTEMPTS = 10;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function getRoomId() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('room');
            
            if (!id) {
                showError('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø¨Ø«.');
                return null;
            }
            
            return id;
        }
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«
        function connectToBroadcast() {
            roomId = getRoomId();
            if (!roomId) return;
            
            connectionAttempts++;
            if (connectionAttempts > MAX_ATTEMPTS) {
                showError('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·.');
                return;
            }
            
            updateStatus('ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø«...', 'waiting');
            loadingText.textContent = `Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${connectionAttempts} Ù…Ù† ${MAX_ATTEMPTS}...`;
            
            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WebSocket');
                updateStatus('ğŸŸ¡ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… - ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...', 'waiting');
                
                // ØªØ³Ø¬ÙŠÙ„ ÙƒØ·Ø§Ù„Ø¨
                ws.send(JSON.stringify({
                    type: 'register_student',
                    roomId: roomId
                }));
                
                loadingText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³...';
                teacherStatus.textContent = 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...';
            };
            
            ws.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    await handleWebSocketMessage(data);
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ WebSocket:', error);
                
                if (connectionAttempts <= 3) {
                    updateStatus('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...', 'disconnected');
                    setTimeout(() => {
                        if (!isConnected) connectToBroadcast();
                    }, 2000);
                } else {
                    showError('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù†:<br>1. Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª<br>2. Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­<br>3. Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø«');
                }
            };
            
            ws.onclose = () => {
                console.log('ğŸ”Œ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebSocket');
                
                if (isConnected) {
                    updateStatus('ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...', 'disconnected');
                    loadingDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        if (!isConnected) connectToBroadcast();
                    }, 3000);
                }
            };
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ WebSocket
        async function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'registered':
                    console.log('âœ… Ù…Ø³Ø¬Ù„ ÙƒØ·Ø§Ù„Ø¨:', data.roomId);
                    updateStatus('ğŸŸ¡ Ù…Ø³Ø¬Ù„ - ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«...', 'waiting');
                    break;
                    
                case 'offer':
                    await handleOffer(data.sdp);
                    break;
                    
                case 'ice_candidate':
                    await handleIceCandidate(data.candidate);
                    break;
                    
                case 'broadcast_status':
                    updateTeacherStatus(data.status);
                    break;
                    
                case 'broadcast_ended':
                    showBroadcastEnded();
                    break;
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
        async function handleOffer(sdp) {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-bundle',
                    rtcpMuxPolicy: 'require'
                });
                
                // Ù…Ø¹Ø§Ù„Ø¬ ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø¨Ø¹ÙŠØ¯
                peerConnection.ontrack = (event) => {
                    console.log('âœ… ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø·');
                    remoteVideo.srcObject = event.streams[0];
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    loadingDiv.style.display = 'none';
                    updateStatus('ğŸŸ¢ Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø«', 'connected');
                    teacherStatus.textContent = 'ğŸŸ¢ Ù…ØªØµÙ„';
                    streamQuality.textContent = 'Ø¹Ø§Ù„ÙŠØ©';
                    
                    isConnected = true;
                    startTime = new Date();
                    updateBroadcastTime();
                    connectionAttempts = 0;
                    
                    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©
                    startQualityMonitoring();
                };
                
                // Ù…Ø¹Ø§Ù„Ø¬ ICE Candidate
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'ice_candidate',
                            roomId: roomId,
                            candidate: event.candidate,
                            target: 'teacher'
                        }));
                    }
                };
                
                // Ù…Ø¹Ø§Ù„Ø¬ ICE Connection State
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('ICE Connection State:', peerConnection.iceConnectionState);
                    
                    switch (peerConnection.iceConnectionState) {
                        case 'connected':
                        case 'completed':
                            networkStatus.textContent = 'ğŸŸ¢ Ù…Ù…ØªØ§Ø²';
                            streamQuality.textContent = 'Ø¹Ø§Ù„ÙŠØ©';
                            break;
                        case 'disconnected':
                            networkStatus.textContent = 'ğŸŸ¡ Ø¶Ø¹ÙŠÙ';
                            streamQuality.textContent = 'Ù…ØªÙˆØ³Ø·Ø©';
                            break;
                        case 'failed':
                            networkStatus.textContent = 'ğŸ”´ ÙØ§Ø´Ù„';
                            streamQuality.textContent = 'Ø¶Ø¹ÙŠÙØ©';
                            reconnect();
                            break;
                    }
                };
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¨Ø¹ÙŠØ¯
                await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ù…Ø¯Ø±Ø³
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'answer',
                        roomId: roomId,
                        sdp: answer
                    }));
                }
                
                updateStatus('ğŸŸ¢ Ù…ØªØµÙ„! Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø«...', 'connected');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                showError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ICE Candidate Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
        async function handleIceCandidate(candidate) {
            if (peerConnection && candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ICE Candidate:', error);
                }
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
        function updateTeacherStatus(status) {
            teacherStatus.textContent = status === 'active' ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸŸ¡ ØºÙŠØ± Ù†Ø´Ø·';
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«
        function startQualityMonitoring() {
            setInterval(() => {
                if (!peerConnection || !isConnected) return;
                
                const stats = peerConnection.getStats();
                stats.then(report => {
                    report.forEach(stat => {
                        if (stat.type === 'inbound-rtp' && stat.kind === 'video') {
                            const frameRate = stat.framesPerSecond || 0;
                            const bitrate = (stat.bytesReceived * 8) / 1000;
                            
                            let quality = 'Ø¹Ø§Ù„ÙŠØ©';
                            if (frameRate < 15 || bitrate < 500) quality = 'Ù…ØªÙˆØ³Ø·Ø©';
                            if (frameRate < 10 || bitrate < 200) quality = 'Ø¶Ø¹ÙŠÙØ©';
                            
                            streamQuality.textContent = quality;
                        }
                    });
                });
            }, 5000);
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø¨Ø«
        function updateBroadcastTime() {
            if (!startTime) return;
            
            setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr += hours.toString().padStart(2, '0') + ':';
                }
                timeStr += minutes.toString().padStart(2, '0') + ':' + 
                          seconds.toString().padStart(2, '0');
                
                broadcastTime.textContent = timeStr;
            }, 1000);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateStatus(message, className) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${className}`;
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
        function showError(message) {
            updateStatus(message, 'disconnected');
            loadingText.innerHTML = message + '<br><br>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';
            loadingDiv.style.display = 'block';
        }
        
        // Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø«
        function showBroadcastEnded() {
            updateStatus('â¹ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', 'disconnected');
            loadingDiv.style.display = 'block';
            loadingText.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ</div>
                <h3 style="color: white; margin-bottom: 10px;">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                <p style="color: #aaa; margin-bottom: 20px;">Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ø¨Ø¯Ø¡ Ø¨Ø« Ø¬Ø¯ÙŠØ¯</p>
            `;
            isConnected = false;
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
        function toggleFullscreen() {
            const container = document.querySelector('.video-container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØª
        function toggleAudio() {
            if (audioMuted) {
                remoteVideo.muted = false;
                audioBtn.innerHTML = '<span>ğŸ”Š</span><span>Ø§Ù„ØµÙˆØª</span>';
                audioMuted = false;
            } else {
                remoteVideo.muted = true;
                audioBtn.innerHTML = '<span>ğŸ”‡</span><span>ÙƒØªÙ…</span>';
                audioMuted = true;
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function reconnect() {
            connectionAttempts = 0;
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            updateStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', 'waiting');
            loadingDiv.style.display = 'block';
            loadingText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...';
            
            setTimeout(connectToBroadcast, 1000);
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            console.log('ğŸš€ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ø§Ù‡Ø²Ø©');
            connectToBroadcast();
            
            // ØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(() => {
                if (!isConnected && connectionAttempts < MAX_ATTEMPTS) {
                    console.log('ğŸ”„ ØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„...');
                    reconnect();
                }
            }, 30000);
        };
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
    </html>
