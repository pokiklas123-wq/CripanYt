<!DOCTYPE html>
<html>
<head>
    <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        video { width: 100%; max-width: 600px; background: #000; }
        button { padding: 10px 20px; margin: 5px; }
        #status { padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯</h1>
    
    <div>
        <input type="text" id="roomId" value="live1" placeholder="Room ID">
        <button id="joinBtn">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«</button>
    </div>
    
    <div id="status">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©</div>
    
    <video id="remoteVideo" autoplay playsinline controls></video>
    
    <script>
        const SERVER = 'wss://cripanyt.onrender.com';
        let socket;
        let peerConnection;
        let roomId;
        
        document.getElementById('joinBtn').onclick = joinRoom;
        
        function joinRoom() {
            roomId = document.getElementById('roomId').value;
            if (!roomId) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©');
            
            document.getElementById('status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            document.getElementById('joinBtn').disabled = true;
            
            socket = new WebSocket(SERVER);
            
            socket.onopen = () => {
                socket.send(JSON.stringify({
                    type: 'join-room',
                    roomId: roomId
                }));
            };
            
            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'room-joined') {
                    document.getElementById('status').textContent = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...';
                    console.log('âœ… Joined room');
                }
                else if (data.type === 'offer') {
                    await handleOffer(data.sdp);
                }
                else if (data.type === 'ice-candidate') {
                    if (peerConnection && peerConnection.remoteDescription) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                }
                else if (data.type === 'broadcast-ended') {
                    document.getElementById('status').textContent = 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø«';
                    if (peerConnection) peerConnection.close();
                    document.getElementById('joinBtn').disabled = false;
                }
                else if (data.type === 'error') {
                    alert(data.message);
                    document.getElementById('joinBtn').disabled = false;
                }
            };
            
            socket.onclose = () => {
                document.getElementById('status').textContent = 'Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„';
                document.getElementById('joinBtn').disabled = false;
            };
        }
        
        async function handleOffer(sdp) {
            if (peerConnection) peerConnection.close();
            
            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            peerConnection.ontrack = (event) => {
                if (document.getElementById('remoteVideo').srcObject !== event.streams[0]) {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('status').textContent = 'ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ø¨Ø« Ø§Ù„Ø¢Ù†';
                }
            };
            
            // Ø¥Ø±Ø³Ø§Ù„ ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket.readyState === 1) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: roomId
                    }));
                }
            };
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.send(JSON.stringify({
                type: 'answer',
                sdp: answer,
                roomId: roomId
            }));
        }
    </script>
</body>
</html>
