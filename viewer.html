<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø«</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a2e; color: white; margin: 0; }
        .container { max-width: 1000px; margin: auto; }
        .input-group { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        input, button { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; border-radius: 5px; border: none; }
        input { background: #0f3460; color: white; }
        button { background: #7209b7; color: white; cursor: pointer; font-weight: bold; }
        button:disabled { background: #555; cursor: not-allowed; }
        video { width: 100%; background: black; border-radius: 10px; display: block; }
        .status { padding: 15px; border-radius: 5px; margin: 15px 0; text-align: center; font-size: 18px; }
        .connected { background: #2ec4b6; }
        .disconnected { background: #e71d36; }
        .connecting { background: #f8961e; }
        .overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
            color: white;
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 15px;
            z-index: 10;
            width: 80%;
            max-width: 500px;
        }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            border-radius: 10px; 
            font-family: monospace; 
            height: 200px; 
            overflow-y: scroll;
            margin-top: 20px;
            border: 2px solid #4cc9f0;
        }
        .video-container {
            position: relative;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #4cc9f0;">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
        
        <div class="input-group">
            <label style="display: block; margin-bottom: 10px; font-size: 18px;">ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«:</label>
            <input type="text" id="roomId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: test123)">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="joinBtn">ğŸš€ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«</button>
                <button id="leaveBtn" disabled>â¹ï¸ Ù…ØºØ§Ø¯Ø±Ø©</button>
            </div>
        </div>
        
        <div id="status" class="status disconnected">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ - Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« ÙˆØ§Ù†Ø¶Ù…</div>
        
        <div class="video-container">
            <div id="overlay" class="overlay">
                <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“º</div>
                <h2 style="margin-bottom: 10px;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«</h2>
                <p style="color: #a1cae2; line-height: 1.6;">Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ø¶ØºØ· "Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«" Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
                <div style="margin-top: 20px; color: #6c757d; font-size: 14px;">
                    âš¡ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø£Ù‚Ù„ Ù…Ù† 500ms
                </div>
            </div>
            <video id="remoteVideo" autoplay playsinline controls style="width: 100%; height: auto;"></video>
        </div>
        
        <h3 style="color: #4cc9f0;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</h3>
        <div id="log" class="log">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
    </div>

    <script>
        // ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
        const SERVER = 'wss://cripanyt.onrender.com';
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ];
        
        // ===== Ø§Ù„Ø¹Ù†Ø§ØµØ± =====
        const elements = {
            roomId: document.getElementById('roomId'),
            joinBtn: document.getElementById('joinBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            status: document.getElementById('status'),
            remoteVideo: document.getElementById('remoteVideo'),
            overlay: document.getElementById('overlay'),
            log: document.getElementById('log')
        };
        
        // ===== Ø§Ù„Ø­Ø§Ù„Ø© =====
        let state = {
            socket: null,
            peerConnection: null,
            roomId: '',
            hasReceivedStream: false,
            videoPlayAttempts: 0,
            maxPlayAttempts: 10
        };
        
        // ===== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© =====
        function log(message) {
            const time = new Date().toLocaleTimeString();
            elements.log.innerHTML = `[${time}] ${message}<br>` + elements.log.innerHTML;
            console.log(message);
        }
        
        function updateStatus(text, className) {
            elements.status.textContent = text;
            elements.status.className = `status ${className}`;
        }
        
        // ===== 1. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ =====
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            
            if (room) {
                elements.roomId.value = room;
                log(`ğŸ“¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·: ${room}`);
                
                // Ø§Ù†Ø¶Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(() => {
                    if (!state.hasReceivedStream) {
                        log('â³ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
                        elements.joinBtn.click();
                    }
                }, 1500);
            }
            
            log('âœ… ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø§Ù‡Ø²Ø©');
        });
        
        // ===== 2. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø« =====
        elements.joinBtn.onclick = () => {
            state.roomId = elements.roomId.value.trim();
            
            if (!state.roomId) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«');
                return;
            }
            
            log(`ğŸš€ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«: ${state.roomId}`);
            updateStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...', 'connecting');
            
            elements.overlay.innerHTML = `
                <div style="font-size: 60px; animation: pulse 1.5s infinite;">ğŸ”—</div>
                <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
                <p>Ø§Ù„ØºØ±ÙØ©: <strong style="color: #4cc9f0;">${state.roomId}</strong></p>
                <div style="margin-top: 20px; color: #a1cae2;">
                    <div>1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± âœ…</div>
                    <div>2. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© â³</div>
                    <div>3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø« â³</div>
                </div>
            `;
            
            connectToServer();
        };
        
        // ===== 3. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± =====
        function connectToServer() {
            state.socket = new WebSocket(SERVER);
            
            state.socket.onopen = () => {
                log('âœ… Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                const viewerId = `viewer-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;
                state.socket.send(JSON.stringify({
                    type: 'join-room',
                    roomId: state.roomId,
                    viewerId: viewerId,
                    timestamp: Date.now()
                }));
                
                log(`ğŸ“¤ Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… (ID: ${viewerId})`);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                createPeerConnection();
            };
            
            state.socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'room-joined':
                            handleRoomJoined(data);
                            break;
                        case 'offer':
                            handleOffer(data);
                            break;
                        case 'ice-candidate':
                            handleIceCandidate(data);
                            break;
                        case 'error':
                            log(`âŒ Ø®Ø·Ø£: ${data.message}`);
                            updateStatus(`âŒ ${data.message}`, 'disconnected');
                            showErrorOverlay(data.message);
                            break;
                    }
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${error}`);
                }
            };
            
            state.socket.onerror = (error) => {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ WebSocket: ${error}`);
            };
            
            state.socket.onclose = () => {
                log('ğŸ”Œ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                if (!state.hasReceivedStream) {
                    updateStatus('ğŸ”Œ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'disconnected');
                }
            };
            
            elements.joinBtn.disabled = true;
            elements.leaveBtn.disabled = false;
        };
        
        // ===== 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© =====
        function handleRoomJoined(data) {
            log(`âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ${data.roomId}`);
            updateStatus('âœ… Ù…ØªØµÙ„ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹...', 'connecting');
            
            elements.overlay.innerHTML = `
                <div style="font-size: 60px; color: #4cc9f0; animation: pulse 1s infinite;">âœ…</div>
                <h2>ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©!</h2>
                <p>Ø§Ù„ØºØ±ÙØ©: <strong style="color: #4cc9f0;">${data.roomId}</strong></p>
                <p style="color: #a1cae2; margin-top: 20px;">
                    âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±<br>
                    âœ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©<br>
                    â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹...
                </p>
            `;
        };
        
        // ===== 5. Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC =====
        function createPeerConnection() {
            log('ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC...');
            
            state.peerConnection = new RTCPeerConnection({
                iceServers: ICE_SERVERS,
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require'
            });
            
            // ===== Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ =====
            state.peerConnection.ontrack = (event) => {
                log(`ğŸ¬ ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙŠØ§Ø±: ${event.track.kind} (${event.track.label || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'})`);
                
                if (event.streams && event.streams[0]) {
                    state.hasReceivedStream = true;
                    
                    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    setTimeout(() => {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙÙŠØ¯ÙŠÙˆ Ø³Ø§Ø¨Ù‚ØŒ Ù‚Ù… Ø¨Ø¥ÙŠÙ‚Ø§ÙÙ‡
                        if (elements.remoteVideo.srcObject) {
                            elements.remoteVideo.pause();
                            elements.remoteVideo.srcObject = null;
                        }
                        
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        elements.remoteVideo.srcObject = event.streams[0];
                        log(`âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ØªÙŠØ§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (${event.streams[0].id})`);
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                        attemptToPlayVideo();
                        
                    }, 300);
                }
            };
            
            // ===== ICE Candidates =====
            state.peerConnection.onicecandidate = (event) => {
                if (event.candidate && state.socket && state.socket.readyState === WebSocket.OPEN) {
                    state.socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: state.roomId,
                        timestamp: Date.now()
                    }));
                }
            };
            
            // ===== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ =====
            state.peerConnection.onconnectionstatechange = () => {
                const status = state.peerConnection.connectionState;
                log(`ğŸ“Š Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ WebRTC: ${status}`);
                
                if (status === 'connected') {
                    log('ğŸ‰ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
                    updateStatus('ğŸ‰ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ¹ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...', 'connecting');
                } else if (status === 'disconnected' || status === 'failed') {
                    log('âš ï¸ ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ¹');
                    updateStatus('âš ï¸ ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„', 'disconnected');
                }
            };
            
            log('âœ… Ø§ØªØµØ§Ù„ WebRTC Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø«');
        };
        
        // ===== 6. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ =====
        function attemptToPlayVideo() {
            if (state.videoPlayAttempts >= state.maxPlayAttempts) {
                log('âŒ ÙØ´Ù„ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                showErrorOverlay('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                return;
            }
            
            state.videoPlayAttempts++;
            
            elements.remoteVideo.play().then(() => {
                log('â–¶ï¸ Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!');
                elements.overlay.style.display = 'none';
                updateStatus('ğŸ¥ ØªØ´Ø§Ù‡Ø¯ Ø¨Ø«Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹!', 'connected');
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                showSuccessOverlay();
                
            }).catch(error => {
                log(`âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ${state.videoPlayAttempts}/${state.maxPlayAttempts} ÙØ´Ù„Øª: ${error.message}`);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(attemptToPlayVideo, 500);
            });
        };
        
        // ===== 7. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ =====
        function showSuccessOverlay() {
            const successDiv = document.createElement('div');
            successDiv.className = 'overlay';
            successDiv.style.background = 'rgba(46, 196, 182, 0.9)';
            successDiv.style.zIndex = '20';
            successDiv.innerHTML = `
                <div style="font-size: 60px;">ğŸ‰</div>
                <h2>Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„!</h2>
                <p>ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­</p>
            `;
            
            document.querySelector('.video-container').appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 2000);
        };
        
        // ===== 8. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ =====
        function showErrorOverlay(message) {
            elements.overlay.style.display = 'block';
            elements.overlay.innerHTML = `
                <div style="font-size: 60px; color: #e71d36;">âŒ</div>
                <h2 style="color: #e71d36;">ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„</h2>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
                </button>
            `;
        };
        
        // ===== 9. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹ =====
        async function handleOffer(data) {
            log(`ğŸ“¨ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹`);
            
            if (!state.peerConnection) {
                log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ WebRTC');
                return;
            }
            
            try {
                // 1. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙˆØµÙ Ø¨Ø¹ÙŠØ¯
                await state.peerConnection.setRemoteDescription(
                    new RTCSessionDescription(data.offer)
                );
                log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙˆØµÙ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨Ø¹ÙŠØ¯');
                
                // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                const answer = await state.peerConnection.createAnswer();
                await state.peerConnection.setLocalDescription(answer);
                log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
                
                // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(() => {
                    if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                        state.socket.send(JSON.stringify({
                            type: 'answer',
                            answer: answer,
                            roomId: state.roomId,
                            timestamp: Date.now()
                        }));
                        log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ¹');
                    }
                }, 300);
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶: ${error.message}`);
            }
        };
        
        // ===== 10. Ù…Ø¹Ø§Ù„Ø¬Ø© ICE Candidate =====
        function handleIceCandidate(data) {
            if (state.peerConnection && data.candidate) {
                state.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
                    .then(() => log('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ICE candidate'))
                    .catch(e => log(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ICE: ${e.message}`));
            }
        };
        
        // ===== 11. Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø« =====
        function leaveStream() {
            log('ğŸ‘‹ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø«...');
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebRTC
            if (state.peerConnection) {
                state.peerConnection.close();
                state.peerConnection = null;
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ WebSocket
            if (state.socket) {
                state.socket.close();
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            elements.remoteVideo.srcObject = null;
            elements.overlay.style.display = 'block';
            elements.overlay.innerHTML = `
                <div style="font-size: 60px;">ğŸ“º</div>
                <h2>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«</h2>
                <p>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« ÙˆØ§Ø¶ØºØ· "Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«"</p>
            `;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            state = {
                socket: null,
                peerConnection: null,
                roomId: '',
                hasReceivedStream: false,
                videoPlayAttempts: 0,
                maxPlayAttempts: 10
            };
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            elements.joinBtn.disabled = false;
            elements.leaveBtn.disabled = true;
            
            updateStatus('ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„', 'disconnected');
            log('âœ… ØªÙ…Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        };
        
        // ===== 12. Ø­Ø¯Ø« Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© =====
        elements.leaveBtn.onclick = leaveStream;
        
        // ===== 13. Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù„ÙˆØ¨ CSS Ù„Ù„Ù†Ø¨Ø¶ =====
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        log('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
    </script>
</body>
</html>
