<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f59e0b; }
        h1 { color: #f59e0b; font-size: 2.2rem; margin-bottom: 10px; }
        .subtitle { color: #cbd5e1; font-size: 1.1rem; }
        
        .main-content { display: flex; flex-wrap: wrap; gap: 30px; }
        .join-panel { flex: 1; min-width: 300px; background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid #475569; }
        .video-container { flex: 2; min-width: 300px; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7); position: relative; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500; }
        input { width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #475569; border-radius: 8px; color: white; font-size: 1rem; }
        input:focus { outline: none; border-color: #f59e0b; }
        
        .buttons { display: flex; gap: 12px; margin-top: 25px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        #joinBtn { background: linear-gradient(to right, #f59e0b, #fbbf24); color: #1e293b; }
        #leaveBtn { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid #475569; }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .status.connecting { background: rgba(245, 158, 11, 0.1); color: #fbbf24; }
        .status.connected { background: rgba(34, 197, 94, 0.1); color: #4ade80; }
        .status.disconnected { background: rgba(239, 68, 68, 0.1); color: #f87171; }
        
        video { width: 100%; height: auto; max-height: 600px; display: block; }
        .video-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.7); z-index: 10; }
        .video-overlay.hidden { display: none; }
        .overlay-icon { font-size: 4rem; margin-bottom: 20px; color: #f59e0b; }
        
        .info-box { background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-top: 20px; }
        
        footer { text-align: center; margin-top: 40px; color: #cbd5e1; font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            .join-panel, .video-container { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
            <p class="subtitle">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
        </header>
        
        <div class="main-content">
            <div class="join-panel">
                <h2 style="margin-bottom: 20px; color: #cbd5e1;">ğŸ”— Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«</h2>
                
                <div class="input-group">
                    <label for="viewerRoomId">ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« (Room ID)</label>
                    <input type="text" id="viewerRoomId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·Ø§Ùƒ Ø¥ÙŠØ§Ù‡ Ø§Ù„Ù…Ø¯ÙŠØ¹">
                </div>
                
                <div class="buttons">
                    <button id="joinBtn">ğŸš€ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«</button>
                    <button id="leaveBtn" disabled>ğŸ‘‹ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø«</button>
                </div>
                
                <div class="status disconnected" id="status">
                    âšª Ù„Ù… ØªÙ†Ø¶Ù… Ø¨Ø¹Ø¯ - Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« ÙˆØ§Ø¶ØºØ· "Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«"
                </div>
                
                <div class="info-box">
                    <h3 style="color: #fbbf24; margin-bottom: 10px;">ğŸ’¡ ÙƒÙŠÙ ØªØ´Ø§Ù‡Ø¯:</h3>
                    <ol style="padding-right: 20px; line-height: 1.6;">
                        <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹</li>
                        <li>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¹Ù„Ø§Ù‡</li>
                        <li>Ø§Ø¶ØºØ· "Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«"</li>
                        <li>Ø§Ù†ØªØ¸Ø± Ø§ØªØµØ§Ù„ Ø§Ù„Ø¨Ø« (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†)</li>
                    </ol>
                </div>
            </div>
            
            <div class="video-container">
                <div class="video-overlay" id="videoOverlay">
                    <div class="overlay-icon">ğŸ“º</div>
                    <h2 style="color: white; margin-bottom: 10px;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«</h2>
                    <p style="color: #cbd5e1; text-align: center; max-width: 80%;">Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«ØŒ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹</p>
                </div>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <footer>
            <p>Â© 2025 Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | ØªØ¬Ø±Ø¨Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">Ø§Ù„ØªØ£Ø®ÙŠØ± Ø£Ù‚Ù„ Ù…Ù† 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… WebRTC</p>
        </footer>
    </div>

    <script>
        // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const viewerRoomId = document.getElementById('viewerRoomId');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const statusDiv = document.getElementById('status');
        const remoteVideo = document.getElementById('remoteVideo');
        const videoOverlay = document.getElementById('videoOverlay');
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        let peerConnection = null;
        let socket = null;
        let currentRoomId = '';
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ICE[citation:2][citation:10]
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };
        
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¹Ù†ÙˆØ§Ù† Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ
        const SIGNALING_SERVER = 'wss://cripanyt.onrender.co'; // Ø£Ùˆ 'ws://localhost:8080' Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø±Ø§Ø¨Ø· URL
        function getRoomFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                viewerRoomId.value = decodeURIComponent(roomParam);
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
                setTimeout(() => {
                    joinBtn.click();
                }, 500);
            }
        }
        
        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø«
        joinBtn.addEventListener('click', async () => {
            currentRoomId = viewerRoomId.value.trim();
            if (!currentRoomId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«');
                return;
            }
            
            try {
                statusDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...';
                statusDiv.className = 'status connecting';
                videoOverlay.innerHTML = '<div class="overlay-icon">â³</div><h2 style="color: white; margin-bottom: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>';
                videoOverlay.classList.remove('hidden');
                
                // 1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
                connectSignaling();
                
                // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                createPeerConnection();
                
                // 3. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©
                setTimeout(() => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'join-room',
                            roomId: currentRoomId,
                            viewerId: `viewer-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`
                        }));
                    }
                }, 500);
                
                // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ (offer) ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø¯ÙŠØ¹
                setTimeout(async () => {
                    try {
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({
                                type: 'offer',
                                offer: offer,
                                roomId: currentRoomId
                            }));
                        }
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶:', error);
                    }
                }, 1000);
                
                // 5. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                joinBtn.disabled = true;
                leaveBtn.disabled = false;
                viewerRoomId.disabled = true;
                
                console.log('Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ØºØ±ÙØ©:', currentRoomId);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«:', error);
                statusDiv.textContent = 'ğŸ”´ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«';
                statusDiv.className = 'status disconnected';
                resetConnection();
            }
        });
        
        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø«
        leaveBtn.addEventListener('click', () => {
            resetConnection();
            statusDiv.textContent = 'âšª ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¨Ø« - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¨Ø« Ø¢Ø®Ø±';
            statusDiv.className = 'status disconnected';
            
            videoOverlay.innerHTML = '<div class="overlay-icon">ğŸ“º</div><h2 style="color: white; margin-bottom: 10px;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«</h2><p style="color: #cbd5e1;">ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¨Ø«. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø¨Ø« Ø¬Ø¯ÙŠØ¯</p>';
            videoOverlay.classList.remove('hidden');
            
            console.log('ØºØ§Ø¯Ø±Øª Ø§Ù„Ø¨Ø«');
        });
        
        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
        function connectSignaling() {
            socket = new WebSocket(SIGNALING_SERVER);
            
            socket.onopen = () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø© ÙƒÙ…Ø´Ø§Ù‡Ø¯');
            };
            
            socket.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', data);
                    
                    switch (data.type) {
                        case 'room-joined':
                            console.log('âœ… Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ØºØ±ÙØ©:', data.roomId);
                            statusDiv.textContent = `ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¨Ø« - Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©: ${data.roomId}`;
                            statusDiv.className = 'status connected';
                            break;
                            
                        case 'answer':
                            // Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙŠØªÙ„Ù‚Ù‰ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹
                            if (peerConnection && data.answer) {
                                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                            }
                            break;
                            
                        case 'ice-candidate':
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­ ICE
                            if (peerConnection && data.candidate) {
                                try {
                                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                                } catch (e) {
                                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­ ICE:', e);
                                }
                            }
                            break;
                            
                        case 'error':
                            alert(`Ø®Ø·Ø£: ${data.message}`);
                            resetConnection();
                            break;
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
                }
            };
            
            socket.onerror = (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ WebSocket:', error);
                statusDiv.textContent = 'ğŸ”´ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                statusDiv.className = 'status disconnected';
            };
            
            socket.onclose = () => {
                console.log('ğŸ”Œ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                if (statusDiv.className.includes('connected')) {
                    statusDiv.textContent = 'ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                    statusDiv.className = 'status disconnected';
                }
            };
        }
        
        // ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­Ø§Øª ICE
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify
