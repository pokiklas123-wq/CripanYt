<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø«</title>
    <style>
        body { font-family: Arial; margin: 0; padding: 20px; background: #0f172a; color: white; }
        .container { max-width: 1200px; margin: auto; }
        .control-panel { background: #1e293b; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        input, button { padding: 12px; font-size: 16px; border-radius: 5px; border: none; }
        input { width: 70%; background: #334155; color: white; }
        button { width: 28%; margin-left: 2%; background: #3b82f6; color: white; cursor: pointer; }
        button:disabled { background: #475569; cursor: not-allowed; }
        video { width: 100%; background: black; border-radius: 10px; }
        .status { padding: 15px; border-radius: 5px; margin: 15px 0; text-align: center; }
        .green { background: #10b981; }
        .red { background: #ef4444; }
        .yellow { background: #f59e0b; }
        .log { background: #000; color: #0f0; padding: 15px; border-radius: 5px; height: 200px; overflow-y: scroll; font-family: monospace; }
        .loading { text-align: center; padding: 50px; font-size: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #60a5fa;">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
        
        <div class="control-panel">
            <input type="text" id="roomId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« (Ù…Ø«Ø§Ù„: test123)">
            <button id="joinBtn">ğŸš€ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø«</button>
            <button id="leaveBtn" disabled>â¹ï¸ Ù…ØºØ§Ø¯Ø±Ø©</button>
        </div>
        
        <div id="status" class="status red">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„</div>
        
        <div id="loading" class="loading" style="display: none;">
            <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
            <h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
        </div>
        
        <video id="remoteVideo" playsinline></video>
        
        <h3 style="color: #60a5fa; margin-top: 30px;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</h3>
        <div id="log" class="log">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø« Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¬Ù„...</div>
    </div>

    <script>
        // === Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===
        const SERVER = 'wss://cripanyt.onrender.com';
        
        // === Ø§Ù„Ø¹Ù†Ø§ØµØ± ===
        const elements = {
            roomId: document.getElementById('roomId'),
            joinBtn: document.getElementById('joinBtn'),
            leaveBtn: document.getElementById('leaveBtn'),
            status: document.getElementById('status'),
            remoteVideo: document.getElementById('remoteVideo'),
            loading: document.getElementById('loading'),
            log: document.getElementById('log')
        };
        
        // === Ø§Ù„Ø­Ø§Ù„Ø© ===
        let state = {
            socket: null,
            peerConnection: null,
            roomId: '',
            stream: null,
            isPlaying: false
        };
        
        // === Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ===
        function log(message) {
            const time = new Date().toLocaleTimeString();
            elements.log.innerHTML = `[${time}] ${message}<br>` + elements.log.innerHTML;
            console.log(message);
        }
        
        function updateStatus(text, color) {
            elements.status.textContent = text;
            elements.status.className = `status ${color}`;
        }
        
        // === 1. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø« ===
        elements.joinBtn.onclick = () => {
            state.roomId = elements.roomId.value.trim();
            
            if (!state.roomId) {
                alert('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«');
                return;
            }
            
            log(`ğŸš€ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«: ${state.roomId}`);
            updateStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', 'yellow');
            elements.loading.style.display = 'block';
            elements.remoteVideo.style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            elements.remoteVideo.srcObject = null;
            elements.remoteVideo.load();
            
            connectToServer();
        };
        
        // === 2. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ===
        function connectToServer() {
            state.socket = new WebSocket(SERVER);
            
            state.socket.onopen = () => {
                log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                
                state.socket.send(JSON.stringify({
                    type: 'join-room',
                    roomId: state.roomId,
                    viewerId: 'viewer-' + Date.now()
                }));
                
                createPeerConnection();
            };
            
            state.socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'room-joined') {
                        log('âœ… Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ØºØ±ÙØ©');
                        updateStatus('âœ… Ù…ØªØµÙ„ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø«...', 'yellow');
                    }
                    else if (data.type === 'offer') {
                        handleOffer(data);
                    }
                    else if (data.type === 'ice-candidate') {
                        handleIceCandidate(data);
                    }
                    else if (data.type === 'error') {
                        log(`âŒ ${data.message}`);
                        updateStatus(`âŒ ${data.message}`, 'red');
                    }
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø£: ${error}`);
                }
            };
            
            state.socket.onerror = () => {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            };
            
            elements.joinBtn.disabled = true;
            elements.leaveBtn.disabled = false;
        };
        
        // === 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC ===
        function createPeerConnection() {
            log('ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC');
            
            state.peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            // === Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===
            state.peerConnection.ontrack = (event) => {
                log(`ğŸ¬ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ${event.track.kind}`);
                
                if (event.streams[0]) {
                    state.stream = event.streams[0];
                    
                    // ØªØ£Ø®ÙŠØ± ÙƒØ¨ÙŠØ± Ù‚Ø¨Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    setTimeout(() => {
                        elements.remoteVideo.srcObject = null; // Ø¥ÙØ±Ø§Øº Ø£ÙˆÙ„Ø§Ù‹
                        
                        setTimeout(() => {
                            elements.remoteVideo.srcObject = state.stream;
                            log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ØªÙŠØ§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                            
                            // ØªØ£Ø®ÙŠØ± Ø£ÙƒØ¨Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
                            setTimeout(() => {
                                playVideoWithRetry();
                            }, 1000); // ØªØ£Ø®ÙŠØ± 1 Ø«Ø§Ù†ÙŠØ©
                            
                        }, 500); // ØªØ£Ø®ÙŠØ± 500ms
                        
                    }, 1000); // ØªØ£Ø®ÙŠØ± 1 Ø«Ø§Ù†ÙŠØ©
                }
            };
            
            state.peerConnection.onicecandidate = (event) => {
                if (event.candidate && state.socket) {
                    state.socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: state.roomId
                    }));
                }
            };
            
            state.peerConnection.onconnectionstatechange = () => {
                if (state.peerConnection.connectionState === 'connected') {
                    log('ğŸ‰ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ¹!');
                }
            };
        };
        
        // === 4. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ===
        function playVideoWithRetry(retryCount = 0) {
            if (retryCount >= 5) {
                log('âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                elements.loading.style.display = 'none';
                elements.remoteVideo.style.display = 'block';
                return;
            }
            
            if (!state.stream || !elements.remoteVideo.srcObject) {
                log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¹Ø¨');
                return;
            }
            
            elements.remoteVideo.play()
                .then(() => {
                    log('âœ… Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ!');
                    elements.loading.style.display = 'none';
                    elements.remoteVideo.style.display = 'block';
                    updateStatus('ğŸ¥ ØªØ´Ø§Ù‡Ø¯ Ø¨Ø«Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹!', 'green');
                    state.isPlaying = true;
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØµØ§Ù…ØªØ§Ù‹
                    elements.remoteVideo.volume = 0;
                    setTimeout(() => {
                        elements.remoteVideo.volume = 1;
                    }, 1000);
                })
                .catch(error => {
                    log(`âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ${retryCount + 1}/5: ${error.message}`);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù…ØªØ²Ø§ÙŠØ¯
                    setTimeout(() => {
                        playVideoWithRetry(retryCount + 1);
                    }, (retryCount + 1) * 500);
                });
        };
        
        // === 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹ ===
        async function handleOffer(data) {
            log('ğŸ“¨ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ¹');
            
            if (!state.peerConnection) return;
            
            try {
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙˆÙ„Ø§Ù‹
                await state.peerConnection.setRemoteDescription(
                    new RTCSessionDescription(data.offer)
                );
                log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶');
                
                // Ø§Ù†ØªØ¸Ø± Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                setTimeout(async () => {
                    try {
                        const answer = await state.peerConnection.createAnswer();
                        await state.peerConnection.setLocalDescription(answer);
                        log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
                        
                        // Ø§Ù†ØªØ¸Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                        setTimeout(() => {
                            if (state.socket) {
                                state.socket.send(JSON.stringify({
                                    type: 'answer',
                                    answer: answer,
                                    roomId: state.roomId
                                }));
                                log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
                            }
                        }, 300);
                        
                    } catch (error) {
                        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${error}`);
                    }
                }, 500);
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶: ${error}`);
            }
        };
        
        // === 6. Ù…Ø¹Ø§Ù„Ø¬Ø© ICE ===
        function handleIceCandidate(data) {
            if (state.peerConnection && data.candidate) {
                // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙØ© ICE
                setTimeout(() => {
                    state.peerConnection.addIceCandidate(
                        new RTCIceCandidate(data.candidate)
                    ).catch(e => log(`âš ï¸ ICE: ${e}`));
                }, 200);
            }
        };
        
        // === 7. Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø« ===
        elements.leaveBtn.onclick = () => {
            log('ğŸ‘‹ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¨Ø«');
            
            if (state.peerConnection) {
                state.peerConnection.close();
                state.peerConnection = null;
            }
            
            if (state.socket) {
                state.socket.close();
            }
            
            elements.remoteVideo.srcObject = null;
            elements.remoteVideo.load();
            elements.loading.style.display = 'none';
            elements.remoteVideo.style.display = 'block';
            
            state = {
                socket: null,
                peerConnection: null,
                roomId: '',
                stream: null,
                isPlaying: false
            };
            
            elements.joinBtn.disabled = false;
            elements.leaveBtn.disabled = true;
            
            updateStatus('ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„', 'red');
        };
        
        // === 8. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ===
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            
            if (room) {
                elements.roomId.value = room;
                setTimeout(() => elements.joinBtn.click(), 1000);
            }
            
            log('âœ… Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©');
        };
    </script>
</body>
    </html>
