<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø·Ø§Ù„Ø¨ - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¨Ø«</title>
    <style>
        body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; }
        video { width: 80%; background: black; border-radius: 10px; margin-top: 20px; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background: #2ec4b6; border: none; border-radius: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mediasoup-client/3.6.85/mediasoup-client.min.js"></script>
</head>
<body>
    <h1>ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¯Ø±Ø³</h1>
    <button id="btnJoin">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«</button>
    <br>
    <video id="remoteVideo" autoplay playsinline controls></video>
    <div id="status"></div>

    <script>
        const ioClient = io;
        const mediasoupClient = mediasoupClient;
        
        const socket = io("http://localhost:3000"); // âš ï¸ ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ù„Ø±Ø§Ø¨Ø· Ø³ÙŠØ±ÙØ±Ùƒ
        
        let device;
        let consumerTransport;
        let videoConsumer;
        let rtpCapabilities;

        const btnJoin = document.getElementById('btnJoin');
        
        btnJoin.addEventListener('click', () => {
            btnJoin.disabled = true;
            joinRoom();
        });

        socket.on('connection-success', ({ socketId }) => {
            console.log("Connected:", socketId);
        });

        // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¨Ø« ÙˆÙ†Ø­Ù† Ù…ØªØµÙ„ÙˆÙ†
        socket.on('new-producer', () => {
            console.log("New producer available");
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        });

        async function joinRoom() {
            socket.emit('getRouterRtpCapabilities', async (rtpCaps) => {
                rtpCapabilities = rtpCaps;
                device = new mediasoupClient.Device();
                await device.load({ routerRtpCapabilities: rtpCapabilities });

                createRecvTransport();
            });
        }

        function createRecvTransport() {
            socket.emit('createWebRtcTransport', { sender: false }, ({ params }) => {
                if (params.error) {
                    console.log(params.error);
                    return;
                }

                consumerTransport = device.createRecvTransport(params);

                consumerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    try {
                        socket.emit('transport-recv-connect', {
                            dtlsParameters,
                            serverConsumerTransportId: params.id,
                        });
                        callback();
                    } catch (error) {
                        errback(error);
                    }
                });

                connectRecvTransport();
            });
        }

        async function connectRecvTransport() {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Producers Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
            socket.emit('getProducers', (producerIds) => {
                if(producerIds.length > 0) {
                    // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ù‡Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    const remoteProducerId = producerIds[0]; 
                    consumeStream(remoteProducerId);
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙˆØª Ø£ÙŠØ¶Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø¹Ù…Ù„ consume Ù„Ù‡ (Ø³ÙŠØ¹ÙˆØ¯ Ø¨Ù€ ID Ø¢Ø®Ø±)
                    if(producerIds.length > 1) consumeStream(producerIds[1]);
                } else {
                    document.getElementById('status').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¹Ù„Ù…...";
                }
            });
        }

        async function consumeStream(remoteProducerId) {
            socket.emit('consume', {
                rtpCapabilities: device.rtpCapabilities,
                remoteProducerId: remoteProducerId,
                serverConsumerTransportId: consumerTransport.id,
            }, async ({ params }) => {
                if (params.error) {
                    console.log('Cannot Consume');
                    return;
                }

                const consumer = await consumerTransport.consume({
                    id: params.id,
                    producerId: params.producerId,
                    kind: params.kind,
                    rtpParameters: params.rtpParameters,
                });

                const { track } = consumer;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø§Ùƒ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
                const remoteVideo = document.getElementById('remoteVideo');
                let stream = remoteVideo.srcObject;
                if (!stream) {
                    stream = new MediaStream();
                    remoteVideo.srcObject = stream;
                }
                stream.addTrack(track);

                // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                socket.emit('consumer-resume', { serverConsumerId: params.id });
                document.getElementById('status').innerText = "ğŸŸ¢ Ù…ØªØµÙ„";
            });
        }
    </script>
</body>
</html>
