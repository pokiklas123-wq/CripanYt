<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¯ÙŠØ¹ - Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #00adb5; }
        h1 { color: #00adb5; font-size: 2.2rem; margin-bottom: 10px; }
        .subtitle { color: #a1cae2; font-size: 1.1rem; }
        
        .main-content { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 30px; }
        .control-panel { flex: 1; min-width: 300px; background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid #30475e; }
        .video-panel { flex: 2; min-width: 300px; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #a1cae2; font-weight: 500; }
        input { width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #30475e; border-radius: 8px; color: white; font-size: 1rem; }
        input:focus { outline: none; border-color: #00adb5; }
        
        .buttons { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 25px; }
        button { flex: 1; min-width: 140px; padding: 14px; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        #startBtn { background: linear-gradient(to right, #00b09b, #96c93d); color: white; }
        #stopBtn { background: linear-gradient(to right, #ff416c, #ff4b2b); color: white; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .link-box { background: rgba(0, 173, 181, 0.1); border: 1px dashed #00adb5; border-radius: 8px; padding: 15px; margin-top: 20px; }
        #broadcastLink { word-break: break-all; color: #4cc9f0; }
        #copyBtn { background: #30475e; color: white; margin-top: 10px; }
        
        .video-container { background: #000; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        video { width: 100%; height: auto; max-height: 500px; display: block; }
        .status { text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-top: 20px; }
        .status.connected { background: rgba(0, 255, 0, 0.1); color: #4ade80; }
        .status.disconnected { background: rgba(255, 0, 0, 0.1); color: #f87171; }
        
        footer { text-align: center; margin-top: 40px; color: #a1cae2; font-size: 0.9rem; }
        
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            .control-panel, .video-panel { width: 100%; }
            button { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¥ Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
            <p class="subtitle">Ø§Ø¨Ø¯Ø£ Ø¨Ø«Ùƒ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆØ´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø¬Ù…Ù‡ÙˆØ±Ùƒ</p>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 style="margin-bottom: 20px; color: #a1cae2;">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                
                <div class="input-group">
                    <label for="roomId">ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« (Room ID)</label>
                    <input type="text" id="roomId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±ÙØ§Ù‹ Ù…Ù…ÙŠØ²Ø§Ù‹ Ù„Ù„Ø¨Ø«ØŒ Ù…Ø«Ù„Ø§Ù‹: my-live-stream-123" value="live-room-<?php echo rand(1000,9999); ?>">
                </div>
                
                <div class="buttons">
                    <button id="startBtn">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
                    <button id="stopBtn" disabled>â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
                </div>
                
                <div class="link-box">
                    <p style="margin-bottom: 10px; color: #a1cae2;">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:</p>
                    <p id="broadcastLink" style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</p>
                    <button id="copyBtn" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                </div>
                
                <div class="status disconnected" id="status">
                    âšª ØºÙŠØ± Ù…ØªØµÙ„ - Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø« ÙˆØ§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«"
                </div>
            </div>
            
            <div class="video-panel">
                <h2 style="margin-bottom: 15px; color: #a1cae2;">ğŸ“¹ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø¯ÙŠØ¹</h2>
                <div class="video-container">
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <p style="text-align: center; margin-top: 10px; color: #a1cae2; font-size: 0.9rem;">Ù‡Ø°Ø§ Ù…Ø§ ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø¯ÙŠØ¹ (Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØµØ§Ù…Øª)</p>
            </div>
        </div>
        
        <footer>
            <p>Â© 2025 Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© WebRTC</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©: Chrome, Firefox, Edge, Safari</p>
        </footer>
    </div>

    <script>
        // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const roomIdInput = document.getElementById('roomId');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const broadcastLink = document.getElementById('broadcastLink');
        const copyBtn = document.getElementById('copyBtn');
        const statusDiv = document.getElementById('status');
        const localVideo = document.getElementById('localVideo');
        
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        let localStream = null;
        let peerConnection = null;
        let socket = null;
        let currentRoomId = '';
        const viewers = new Set();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª STUN/ICE (Ù…Ù‡Ù…Ø© Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† Ø§Ù„Ù†Ø§Ø±ÙŠØ©)[citation:2][citation:7]
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };
        
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø¹Ù†ÙˆØ§Ù† Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙØ¹Ù„ÙŠ
        const SIGNALING_SERVER = 'wss://cripanyt.onrender.co'; // Ø£Ùˆ 'ws://localhost:8080' Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        startBtn.addEventListener('click', async () => {
            currentRoomId = roomIdInput.value.trim();
            if (!currentRoomId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«');
                return;
            }
            
            try {
                statusDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø«...';
                statusDiv.className = 'status';
                
                // 1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
                connectSignaling();
                
                // 2. Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†[citation:7]
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                
                // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                createPeerConnection();
                
                // 4. Ø¥Ø¶Ø§ÙØ© ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø­Ù„ÙŠ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // 5. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ù„Ù„Ø³ÙŠØ±ÙØ±
                socket.send(JSON.stringify({
                    type: 'create-room',
                    roomId: currentRoomId
                }));
                
                // 6. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                startBtn.disabled = true;
                stopBtn.disabled = false;
                roomIdInput.disabled = true;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«
                const viewerUrl = `${window.location.origin}/viewer.html?room=${encodeURIComponent(currentRoomId)}`;
                broadcastLink.textContent = viewerUrl;
                broadcastLink.href = viewerUrl;
                copyBtn.disabled = false;
                
                statusDiv.textContent = `ğŸŸ¢ Ø§Ù„Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©: ${currentRoomId}`;
                statusDiv.className = 'status connected';
                
                console.log('Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ØºØ±ÙØ©:', currentRoomId);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«:', error);
                statusDiv.textContent = 'ğŸ”´ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« - ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
                statusDiv.className = 'status disconnected';
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
            }
        });
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
        stopBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'leave-room',
                    roomId: currentRoomId
                }));
                socket.close();
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            roomIdInput.disabled = false;
            copyBtn.disabled = true;
            
            broadcastLink.textContent = 'Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«';
            broadcastLink.href = '#';
            
            statusDiv.textContent = 'âšª Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù - ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø¨Ø« Ø¬Ø¯ÙŠØ¯';
            statusDiv.className = 'status disconnected';
            
            console.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«');
        });
        
        // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(broadcastLink.textContent);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:', err);
                alert('ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
            }
        });
        
        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
        function connectSignaling() {
            socket = new WebSocket(SIGNALING_SERVER);
            
            socket.onopen = () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©');
            };
            
            socket.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', data);
                    
                    switch (data.type) {
                        case 'room-created':
                            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©:', data.roomId);
                            break;
                            
                        case 'new-viewer':
                            console.log('ğŸ‘¤ Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯:', data.viewerId);
                            viewers.add(data.viewerId);
                            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ù‡Ù†Ø§
                            break;
                            
                        case 'offer':
                            // Ø§Ù„Ù…Ø¯ÙŠØ¹ ÙŠØªÙ„Ù‚Ù‰ Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ù† Ù…Ø´Ø§Ù‡Ø¯ (Ù†Ù…ÙˆØ°Ø¬ P2P ÙƒØ§Ù…Ù„)
                            if (peerConnection && data.offer) {
                                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                                const answer = await peerConnection.createAnswer();
                                await peerConnection.setLocalDescription(answer);
                                
                                socket.send(JSON.stringify({
                                    type: 'answer',
                                    answer: answer,
                                    roomId: currentRoomId,
                                    to: data.from
                                }));
                            }
                            break;
                            
                        case 'ice-candidate':
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­ ICE
                            if (peerConnection && data.candidate) {
                                try {
                                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                                } catch (e) {
                                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­ ICE:', e);
                                }
                            }
                            break;
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
                }
            };
            
            socket.onerror = (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ WebSocket:', error);
                statusDiv.textContent = 'ğŸ”´ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                statusDiv.className = 'status disconnected';
            };
            
            socket.onclose = () => {
                console.log('ğŸ”Œ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                if (statusDiv.className.includes('connected')) {
                    statusDiv.textContent = 'ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± - Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù';
                    statusDiv.className = 'status disconnected';
                }
            };
        }
        
        // ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC[citation:3][citation:7]
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø±Ø´Ø­Ø§Øª ICE
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        roomId: currentRoomId
                    }));
                }
            };
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
            peerConnection.ontrack = (event) => {
                console.log('ğŸ“¹ ØªÙŠØ§Ø± ÙˆØ³Ø§Ø¦Ø· Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…Ø´Ø§Ù‡Ø¯:', event.track.kind);
                // ÙÙŠ Ø¨Ø« Ø£Ø­Ø§Ø¯ÙŠ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ØŒ Ù‚Ø¯ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¹Ø±Ø¶ ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', peerConnection.connectionState);
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                console.log('Ø­Ø§Ù„Ø© ICE:', peerConnection.iceConnectionState);
            };
        }
        
        // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ØºØ±ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹
        roomIdInput.addEventListener('focus', () => {
            if (!roomIdInput.value) {
                roomIdInput.value = `live-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`;
            }
        });
    </script>
</body>
</html>
